---
title: "Master Thesis appendix"
output:
  pdf_document: default
  html_document:
    df_print: paged
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
library(readxl)
library(tidyverse)
library(rvest)
library(haven)
library(lubridate)
library(skimr)
library(plm)
library(broom)
library(GGally)
library(fastDummies)
`%notin%` <- Negate(`%in%`)
Sys.setlocale(locale = "sv_SE.UTF-8")
```
# Elections
## Scraping election data
```{r Election data, echo=TRUE, message=FALSE, warning=FALSE}

# Data ----------------------------------------------------------------------------------------
ID <- read_excel("Data/scrape_sweden/kommunlankod27.xls", 
                 skip = 5) %>% select(municipality = Name,
                                      ID = Code,
                                      province = ...3,
                                      province_ID = ...5) %>%
  filter(!str_detect(municipality," län")) %>%
  mutate(muni_ID = ID)

# 2006 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2006/slutlig/K/rike/delar.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[1]]
elections_sweden <- elections_sweden %>% 
  arrange(Område) %>% 
  rename(municipality = Område,
         invalid = OG,
         blank = BLANK,
         other = `ÖVR`,
         turnout = VDT) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        rename(V_vote_share = V,
               S_vote_share = S,
               MP_vote_share = MP,
               C_vote_share = C,
               L_vote_share = FP,
               KD_vote_share = KD,
               M_vote_share = M,
               other_vote_share = other)


#Clean away dashes and commas, make data into numeric values 
for(j in 2:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}

#SD
other <- read_excel("Data/scrape_sweden/election_2006.xls", 
                    sheet = "Tabell 9", skip = 6) %>% slice(6:373) %>%
  select(municipality = Kommun,
         party = ...2,
         votes = Antal,
         vote_share = `% av samtliga giltiga röster`,
         seats_won = Totalt) %>%
  filter(!is.na(vote_share)) %>%
  mutate(municipality = if_else(municipality == "Heby2", "Heby", municipality)) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
  mutate(party = if_else(party == "Sverigedemokraterna", "SD", party)) %>%
  mutate(party = if_else(party == "SPI - Sveriges Pensionärers Intresseparti", "SPI", party)) %>% 
  fill(municipality) %>%
        filter(party == "SD") %>% 
        select(municipality,
               SD_vote_share = vote_share,
               -seats_won,-votes,-party)

elections_sweden <- elections_sweden %>% left_join(other) %>% 
        mutate_all(~replace(., is.na(.), 0)) %>%
        mutate(other_vote_share = other_vote_share-SD_vote_share)

#Seats        
mandates <- read_html("https://data.val.se/val/val2006/slutlig_ovrigt/statistik/kommun/mandat_kommun_parti.html") %>%
  html_table(header = TRUE, fill = TRUE) %>%
  first() %>% filter(Kommun != "SUMMA") %>%
  rename(municipality = Kommun,
         mandates = TOT) %>% 
  separate(ÖVR, sep = ", ", into = c("other","other2")) %>% #These could be split into separate rows using gsub and regular expressions
  na_if("") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality),
         other = as.integer(str_extract(other, "[1-9]")),
         other2 = as.integer(str_extract(other2, "[1-9]")),
         SPI = as.integer(SPI)) %>%
        mutate_all(~replace(., is.na(.), 0)) %>%
        mutate(other = other+other2+SPI) %>% 
        select(-other2, - SPI) %>%
        rename(V_seats_won = V,
               S_seats_won = S,
               MP_seats_won = MP,
               C_seats_won = C, 
               L_seats_won = FP,
               KD_seats_won = KD,
               M_seats_won = M,
               SD_seats_won = SD,
               other_seats_won = other,
               total_mandates = mandates) 
election06 <- elections_sweden %>% 
        full_join(mandates) %>% 
        mutate(year = "2006") %>%
        select(year, everything())
sweden <- election06



# 2010 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2010/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[2]]

elections_sweden <- elections_sweden[,c(1,2,4,6,8,10,12,14,16,18,20,22,24)]  %>%
        arrange(Område) %>% 
  rename(municipality = Område,
         invalid = OG,
         blank = BLANK,
         other = `ÖVR`,
         turnout = VDT) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        rename(V_vote_share = V,
               S_vote_share = S,
               MP_vote_share = MP,
               C_vote_share = C,
               L_vote_share = FP,
               KD_vote_share = KD,
               M_vote_share = M,
               SD_vote_share = SD,
               other_vote_share = other) %>% 
  filter(!municipality == "Sverige")

#Clean away dashes and commas, make data into numeric values 
for(j in 2:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}

elections_sweden <- elections_sweden %>% mutate_all(~replace(., is.na(.), 0))


#Seats for national parties        
mandates <- read_html("https://data.val.se/val/val2010/slutresultat/K/rike/valda.html") %>%
  html_table(header = TRUE, fill = TRUE)
mandates <- mandates[[2]] %>% filter(Område != "Sverige")  %>%
rename(municipality = Område,
         mandates = TOT) %>% 
        mutate(other = as.integer(str_extract(ÖVR, "[1-9]"))) %>% #These could be split into separate rows using gsub and regular expressions
  na_if("") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        mutate_all(~replace(., is.na(.), 0)) %>%
        select(-ÖVR) %>%
        rename(V_seats_won = V,
               S_seats_won = S,
               MP_seats_won = MP,
               C_seats_won = C, 
               L_seats_won = FP,
               KD_seats_won = KD,
               M_seats_won = M,
               SD_seats_won = SD,
               other_seats_won = other,
               total_mandates = mandates)

election10 <- elections_sweden %>% 
        full_join(mandates) %>% 
        mutate(year = "2010") %>%
        select(year, everything())
sweden <- rbind(sweden,election10)

# 2014 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2014/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[2]]

elections_sweden <- elections_sweden[,c(1,2,4,6,8,10,12,14,16,18,20,22,24,26)] %>%
        arrange(Område) %>% 
  rename(municipality = Område,
         invalid = OG,
         blank = BLANK,
         other = `ÖVR`,
         turnout = VDT) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        rename(V_vote_share = V,
               S_vote_share = S,
               MP_vote_share = MP,
               C_vote_share = C,
               L_vote_share = FP,
               KD_vote_share = KD,
               M_vote_share = M,
               SD_vote_share = SD,
               other_vote_share = other) %>% 
  filter(!municipality == "Sverige")

#Clean away dashes and commas, make data into numeric values 
for(j in 2:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}

elections_sweden <- elections_sweden %>%
        mutate_all(~replace(., is.na(.), 0)) %>% 
        mutate(other_vote_share = other_vote_share+FI) %>% 
        select(-FI)

#Seats for national parties        
mandates <- read_html("https://data.val.se/val/val2014/slutresultat/K/rike/valda.html") %>%
  html_table(header = TRUE, fill = TRUE)
mandates <- mandates[[2]] %>% filter(Område != "Sverige")  %>%
rename(municipality = Område,
         mandates = TOT) %>% 
        mutate(other = as.integer(str_extract(ÖVR, "[1-9]"))) %>% #These could be split into separate rows using gsub and regular expressions
  na_if("") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        mutate_all(~replace(., is.na(.), 0)) %>%
        select(-ÖVR) %>%
        rename(V_seats_won = V,
               S_seats_won = S,
               MP_seats_won = MP,
               C_seats_won = C, 
               L_seats_won = FP,
               KD_seats_won = KD,
               M_seats_won = M,
               SD_seats_won = SD,
               other_seats_won = other,
               total_mandates = mandates) %>%
        mutate(other_seats_won = other_seats_won+FI) %>% 
        select(-FI)


election14 <- elections_sweden %>% 
        full_join(mandates) %>% 
        mutate(year = "2014") %>%
        select(year, everything())
sweden <- rbind(sweden,election14)

# 2018 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2018/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[2]]
elections_sweden <- elections_sweden[,c(1,2,4,6,8,10,12,14,16,18,20,22,24,26,28)] %>%
        arrange(Område) %>% 
  rename(municipality = Område,
         invalid = OG,
         blank = BLANK,
         other = `ÖVR`,
         turnout = VDT) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        rename(V_vote_share = V,
               S_vote_share = S,
               MP_vote_share = MP,
               C_vote_share = C,
               L_vote_share = L,
               KD_vote_share = KD,
               M_vote_share = M,
               SD_vote_share = SD,
               other_vote_share = other) %>% 
  filter(!municipality == "Sverige")

#Clean away dashes and commas, make data into numeric values 
for(j in 2:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}

elections_sweden <- elections_sweden %>%
        mutate_all(~replace(., is.na(.), 0)) %>% 
        mutate(other_vote_share = other_vote_share+FI,
               invalid = invalid+OGEJ) %>% 
        select(-FI,-OGEJ)


#Seats for national parties        
mandates <- read_html("https://data.val.se/val/val2018/slutresultat/K/rike/valda.html") %>%
  html_table(header = TRUE, fill = TRUE)
mandates <- mandates[[2]] %>% filter(Område != "Sverige") %>%
rename(municipality = Område,
         mandates = TOT) %>% 
        mutate(other = as.integer(str_extract(ÖVR, "[1-9]"))) %>% #These could be split into separate rows using gsub and regular expressions
  na_if("") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        mutate_all(~replace(., is.na(.), 0)) %>%
        select(-ÖVR) %>%
        rename(V_seats_won = V,
               S_seats_won = S,
               MP_seats_won = MP,
               C_seats_won = C, 
               L_seats_won = L,
               KD_seats_won = KD,
               M_seats_won = M,
               SD_seats_won = SD,
               other_seats_won = other,
               total_mandates = mandates) %>%
        mutate(other_seats_won = other_seats_won+FI) %>% 
        select(-FI)


election18 <- elections_sweden %>% 
        full_join(mandates) %>% 
        mutate(year = "2018") %>%
        select(year, everything())
sweden <- rbind(sweden,election18)



# 2002 ----------------------------------------------------------------------------------------
#missing local parties
# 2002
elections_sweden <- read_excel("Data/scrape_sweden/2002_votes.xlsx", skip = 3) %>% 
  select(muni_ID = ...1,
         municipality = ...2,
         party = ...3,
         votes = `2002...5`,
         vote_share = `2002...6`) %>%
  fill(muni_ID,municipality) %>%
  slice(1:3201) %>%
  filter(municipality != "Bara") 

votes <- elections_sweden %>% group_by(municipality) %>%
  mutate(eligible_voters = sum(votes)) %>%
  filter(party != "VALSKOLKARE") %>% 
  mutate(total_voters = sum(votes)) %>%
  filter(party != "OGILTIGA") %>%
  mutate(valid_votes = sum(votes)) %>%
  mutate(turnout = total_voters/eligible_voters) %>%
  filter(party == "M") %>%
  filter(municipality != "Bara") %>%
  select(muni_ID, municipality, eligible_voters:turnout) %>%
        select(municipality, turnout)

elections_sweden <- elections_sweden %>% 
        select(-votes,-muni_ID) %>% 
        pivot_wider(names_from = party, values_from = vote_share) %>%
        left_join(votes) %>% 
        rename(V_vote_share = V,
               S_vote_share = S,
               MP_vote_share = MP,
               C_vote_share = C,
               L_vote_share = FP,
               KD_vote_share = KD,
               M_vote_share = M,
               SD_vote_share = SD,
               other_vote_share = ÖVRIGA,
               invalid = OGILTIGA) %>% 
        select(-VALSKOLKARE)
rm(votes)

mandates <- read_excel("Data/scrape_sweden/2002_mandates.xlsx", skip = 1) %>% 
  select(municipality = ...2,
         party = ...3,
         seats_won = `2002`) %>%
  fill(municipality) %>%
  slice(1:2619) %>%
  mutate(seats_won = as.integer(seats_won)) %>%
  group_by(municipality) %>%
  mutate(mandates = sum(seats_won)) %>%
  filter(!is.na(seats_won)) %>% 
        pivot_wider(names_from = party, values_from = seats_won) %>%
        rename(V_seats_won = V,
               S_seats_won = S,
               MP_seats_won = MP,
               C_seats_won = C, 
               L_seats_won = FP,
               KD_seats_won = KD,
               M_seats_won = M,
               SD_seats_won = SD,
               other_seats_won = ÖVRIGA,
               total_mandates = mandates)

election02 <- elections_sweden %>% 
        full_join(mandates) %>% 
        mutate(year = "2002",
               blank = NA) %>%
        select(year, everything())
sweden <- rbind(sweden,election02)

rm(elections_sweden)

sweden <- sweden %>% rename(muni = municipality)

# misc ----------------------------------------------------------------------------------------
procurement <- read_dta("./Data/procurement/bdf_replication.dta")
```

## Clean
```{r}
rm(election02,election06,election10,election14,election18)
```

# Other
## Chairman desiscions
```{r}
chairman_des <- read_excel("Data/Ordförandebeslut.xlsx") %>% filter(!is.na(Kommun)) %>% 
  rename(year = År) %>%
  mutate(Beslut = as.integer(Beslut))

chair_sum <- chairman_des %>% group_by(Kommun, year) %>%  summarise(nDes = sum(Beslut))
chair_NA <- chairman_des %>% filter(is.na(Beslut))
qplot(chair_NA$year, geom = "histogram",
      binwidth = 1,
      xlab = "Distribution of NAs")

muni_no <- read_excel("Data/Ordförandebeslut.xlsx", sheet = "NEJ", col_names = F) %>% select(denied = `...1`)
muni_no <- unique(muni_no$denied)
muni_yes <- unique(chairman_des$Kommun)
muni_both <- muni_yes[(muni_yes %in% muni_no)]

#Municipalities who gave information
length(muni_yes)

#Municipalities who gave information from some boards, and denied from others
length(muni_both)

#Municipalities who denied
length(muni_no)

muni_reply <- unique(append(muni_yes, muni_no))
290-length(muni_reply)
missing <- ID %>% filter(municipality %notin% muni_reply) %>% arrange(municipality)
missing$municipality
```

## Plot Data
```{r Plot Data, echo=TRUE, message=FALSE, warning=FALSE}
# Data ----------------------------------------------------------------------------------------
# Common
pop <- read_excel("Data/scrape_sweden/pop_sweden_1950-2019.xlsx", 
                  skip = 5) %>% slice(1:290) %>% select(municipality = Kommun,`2002`,`2006`,`2010`,`2014`,`2018`) 
ID <- read_excel("Data/scrape_sweden/kommunlankod27.xls", 
                 skip = 5) %>% select(municipality = Name,
                                      ID = Code,
                                      province = ...3,
                                      province_ID = ...5) %>%
  filter(!str_detect(municipality," län")) %>%
  mutate(muni_ID = ID)


# 2006 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2006/slutlig/K/rike/delar.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[1]]
elections_sweden <- elections_sweden %>% 
  gather(party,vote_share,2:9) %>% 
  arrange(Område) %>% 
  select(municipality = Område,
         party,
         vote_share,
         turnout = VDT) %>%
  filter(!party == "ÖVR") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality))


#Clean away dashes and commas, make data into numeric values 
for(j in 3:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}

other <- read_excel("Data/scrape_sweden/election_2006.xls", 
                    sheet = "Tabell 9", skip = 6) %>% slice(6:373) %>%
  select(municipality = Kommun,
         party = ...2,
         votes = Antal,
         vote_share = `% av samtliga giltiga röster`,
         seats_won = Totalt) %>%
  filter(!is.na(vote_share)) %>%
  mutate(municipality = if_else(municipality == "Heby2", "Heby", municipality)) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
  mutate(party = if_else(party == "Sverigedemokraterna", "SD", party)) %>%
  mutate(party = if_else(party == "SPI - Sveriges Pensionärers Intresseparti", "SPI", party)) %>% 
  fill(municipality)


elections_sweden <- merge(elections_sweden, pop, by = "municipality", all = TRUE)
elections_sweden <- elections_sweden %>% select(-`2010`,-`2014`,-`2018`,-`2002`) %>%
  rename(pop = `2006`)
elections_sweden <- merge(elections_sweden, ID, by = "municipality", all = TRUE)

#Seats        
mandates <- read_html("https://data.val.se/val/val2006/slutlig_ovrigt/statistik/kommun/mandat_kommun_parti.html") %>%
  html_table(header = TRUE, fill = TRUE) %>%
  first() %>% filter(Kommun != "SUMMA") %>%
  gather(party,seats_won,2:11) %>% 
  rename(municipality = Kommun,
         mandates = TOT) %>% 
  separate_rows(seats_won, sep = ", ") %>% #These could be split into separate rows using gsub and regular expressions
  na_if("") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
  group_by(municipality) %>%
  mutate(nParties = sum(!is.na(seats_won))) %>%
  filter(!is.na(seats_won)) %>%
  arrange(municipality)

local <- merge(elections_sweden,mandates, by = c("municipality", "party"), all = TRUE)

local <- local %>% mutate(cname = "Sweden",
                          ccode = "SE",
                          date = "2006-09-17",
                          clevel = "municipality")

voter <- read_excel("Data/scrape_sweden/election_2006.xls", 
                    sheet = "Tabell 7", skip = 5) %>% 
  select(municipality = ...1,
         eligible_voters = ...3,
         total_voters = ...5,
         valid_votes = ...10,
         M=m,C=c,FP=fp,KD=kd,MP=mp,S=s,V=v,ÖVR=övr)%>%
  mutate(municipality = if_else(municipality == "Heby2", "Heby", municipality)) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
  filter(!str_detect(municipality," län")) %>% #NOTE space before län! if not, removes the muni Borlänge
  filter(!is.na(municipality)) %>% 
  filter(municipality != "Hela riket") %>%
  slice(-291:-293) %>%
  gather(party,votes,5:12) %>%
  arrange(municipality)

local <- merge(local,voter, by = c("municipality", "party"), all = TRUE) %>% 
  filter(!party == "SD") %>%
  filter(!party == "ÖVR")
local <- merge(local, other, by = c("municipality","votes","party","vote_share","seats_won"), all = TRUE) %>% 
  arrange(municipality, turnout)
local <- local %>% mutate(seats_won = ifelse(is.na(seats_won), 0, seats_won)) %>% 
  fill(turnout:valid_votes) %>% 
  select(cname, ccode, date, clevel, turnout, ID,
         province_ID, province, muni_ID, municipality, pop, eligible_voters, total_voters,
         valid_votes, party, votes, vote_share, seats_won, mandates, nParties) %>%
  arrange(date, municipality, desc(vote_share))

sweden_plot <- local



# 2010 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2010/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[2]]

elections_sweden <- elections_sweden[,c(1,2,4,6,8,10,12,14,16,18,20,22,24)] %>%
  gather(party,vote_share, 2:9) %>%
  arrange(Område) %>% 
  select(municipality = Område,
         party,
         vote_share,
         turnout = VDT) %>% 
  filter(!municipality == "Sverige")


votes <- read_html("https://data.val.se/val/val2010/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
votes <- votes[[2]]
votes <- votes[,c(1,3,5,7,9,11,13,15,17)] %>%
  gather(party,votes, 2:9) %>%
  rename(municipality = Område)%>% 
  filter(!municipality == "Sverige")
elections_sweden <- merge(elections_sweden, votes, by = c("municipality", "party"))

#Clean away dashes and commas, make data into numeric values 
for(j in 3:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}

#Getting the non-national parties
other <- read_excel("Data/scrape_sweden/election_2010.xls", 
                    sheet = "Tabell 11", skip = 11) %>%
  select(municipality = `Stockholms län`,
         party = ...3,
         votes = ...4,
         vote_share = ...5,
         seats_won = ...9)%>%
  filter(!is.na(vote_share)) %>%
  fill(municipality) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality))

elections_sweden <- merge(elections_sweden, other, by = c("municipality","party","votes","vote_share"), all = TRUE)
elections_sweden <- elections_sweden %>% arrange(municipality, turnout) %>%
  fill(turnout)

#Seats for national parties        
mandates <- read_html("https://data.val.se/val/val2010/slutresultat/K/rike/valda.html") %>%
  html_table(header = TRUE, fill = TRUE)
mandates <- mandates[[2]] %>% filter(Område != "Sverige") %>%
  gather(party,seats_won,2:9) %>% 
  rename(municipality = Område,
         mandates = TOT) %>% 
  group_by(municipality) %>%
  mutate(nParties = sum(!is.na(seats_won))) %>%
  mutate(seats_won = ifelse(is.na(seats_won),0,seats_won)) %>%
  arrange(municipality) %>% select(-ÖVR)

#Merge seats and all other election data
local <- merge(elections_sweden,mandates, by = c("municipality", "party"), all = TRUE)
local <- local %>% mutate(seats_won = if_else(is.na(seats_won.x), seats_won.y, seats_won.x))%>%
  select(-seats_won.x, -seats_won.y) %>% arrange(municipality, mandates) %>%
  fill(mandates:nParties)


#generate the static variables
local <- local %>% mutate(cname = "Sweden",
                          ccode = "SE",
                          date = "2010-09-19",
                          clevel = "municipality")
#pop data and IDs
local <- merge(local, pop, by = "municipality", all = TRUE)
local <- local %>% select(-`2006`,-`2014`,-`2018`,-`2002`) %>%
  rename(pop = `2010`)
local <- merge(local, ID, by = "municipality", all = TRUE)

#Voter data
voter <- read_excel("Data/scrape_sweden/election_2010.xls", 
                    sheet = "Tabell 9", skip = 5) %>% 
  select(municipality = ...1,
         eligible_voters = `berät-`,
         total_voters = ...5,
         valid_votes = giltiga) %>%
  slice(7:336) %>%
  filter(!str_detect(municipality," län")) %>% #NOTE space before län! if not, removes the muni Borlänge
  filter(!is.na(municipality)) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality))

local <- merge(local,voter, by = "municipality", all = TRUE)

#reorder and arrange
local <- local %>% select(cname, ccode, date, clevel, turnout, ID,
                          province_ID, province, muni_ID, municipality, pop, eligible_voters, total_voters,
                          valid_votes, party, votes, vote_share, seats_won, mandates, nParties) %>%
  arrange(date, municipality, desc(vote_share))

sweden_plot <- rbind(sweden_plot, local)


# 2014 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2014/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[2]]

elections_sweden <- elections_sweden[,c(1,2,4,6,8,10,12,14,16,18,20,22,24,26)] %>%
  gather(party,vote_share, 2:10) %>%
  arrange(Område) %>% 
  select(municipality = Område,
         party,
         vote_share,
         turnout = VDT)%>% 
  filter(!municipality == "Sverige")

votes <- read_html("https://data.val.se/val/val2014/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
votes <- votes[[2]]
votes <- votes[,c(1,3,5,7,9,11,13,15,17,19)] %>%
  gather(party,votes, 2:10) %>% #Fi!
  rename(municipality = Område) %>% 
  filter(!municipality == "Sverige")

elections_sweden <- merge(elections_sweden, votes, by = c("municipality", "party"))
rm(votes)

#Clean away dashes and commas, make data into numeric values 
for(j in 3:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}
rm(j)

#Getting the non-national parties
other <- read_excel("Data/scrape_sweden/election_2014.xlsx", 
                    sheet = "Tabell 11", skip = 11) %>%
  select(municipality = `Stockholms län`,
         party = ...3,
         votes = ...4,
         vote_share = ...5,
         seats_won = ...9)%>%
  filter(!is.na(vote_share)) %>% 
  filter(!party == "Feministiskt initiativ")%>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality))

elections_sweden <- merge(elections_sweden, other, by = c("municipality","party","votes","vote_share"), all = TRUE)
elections_sweden <- elections_sweden %>% arrange(municipality, turnout) %>%
  fill(turnout)
rm(other)

#Seats for national parties        
mandates <- read_html("https://data.val.se/val/val2014/slutresultat/K/rike/valda.html") %>%
  html_table(header = TRUE, fill = TRUE)
mandates <- mandates[[2]] %>% filter(Område != "Sverige") %>%
  gather(party,seats_won,2:10) %>% #Fi!
  rename(municipality = Område,
         mandates = TOT) %>% 
  group_by(municipality) %>%
  mutate(nParties = sum(!is.na(seats_won))) %>%
  mutate(seats_won = ifelse(is.na(seats_won),0,seats_won)) %>%
  arrange(municipality) %>% select(-ÖVR)

#Merge seats and all other election data
local <- merge(elections_sweden,mandates, by = c("municipality", "party"), all = TRUE)
local <- local %>% mutate(seats_won = if_else(is.na(seats_won.x), seats_won.y, seats_won.x))%>%
  select(-seats_won.x, -seats_won.y) %>% arrange(municipality, mandates) %>%
  fill(mandates:nParties)
rm(mandates)

#generate the static variables
local <- local %>% mutate(cname = "Sweden",
                          ccode = "SE",
                          date = "2014-09-14",
                          clevel = "municipality")
#pop data and IDs
local <- merge(local, pop, by = "municipality", all = TRUE)
local <- local %>% select(-`2006`,-`2010`,-`2018`,-`2002`) %>%
  rename(pop = `2014`)
local <- merge(local, ID, by = "municipality", all = TRUE)

#Voter data
voter <- read_excel("Data/scrape_sweden/election_2014.xlsx", 
                    sheet = "Tabell 9", skip = 5) %>% 
  select(municipality = ...1,
         eligible_voters = `berät-`,
         total_voters = ...3,
         valid_votes = giltiga) %>%
  slice(7:336) %>%
  filter(!str_detect(municipality," län")) %>% #NOTE space before län! if not, removes the muni Borlänge
  filter(!is.na(municipality)) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality))

local <- merge(local,voter, by = "municipality", all = TRUE)
rm(voter)

#reorder and arrange
local <- local %>% select(cname, ccode, date, clevel, turnout, ID,
                          province_ID, province, muni_ID, municipality, pop, eligible_voters, total_voters,
                          valid_votes, party, votes, vote_share, seats_won, mandates, nParties) %>%
  arrange(date, municipality, desc(vote_share))

sweden_plot <- rbind(sweden_plot, local)


# 2018 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2018/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[2]]
elections_sweden <- elections_sweden[,c(1,2,4,6,8,10,12,14,16,18,20,22,24,26,28)] %>%
  gather(party,vote_share, 2:10) %>%
  arrange(Område) %>% 
  select(municipality = Område,
         party,
         vote_share,
         turnout = VDT)%>% 
  filter(!municipality == "Sverige")

votes <- read_html("https://data.val.se/val/val2018/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
votes <- votes[[2]]
votes <- votes[,c(1,3,5,7,9,11,13,15,17,19)] %>%
  gather(party,votes, 2:10) %>% #Fi!
  rename(municipality = Område)%>% 
  filter(!municipality == "Sverige")
elections_sweden <- merge(elections_sweden, votes, by = c("municipality", "party"))
rm(votes)

#Clean away dashes and commas, make data into numeric values 
for(j in 3:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}
rm(j)

#Getting the non-national parties
other <- read_excel("Data/scrape_sweden/other_2018.xlsx", skip = 11) %>%
  select(municipality = `Stockholms län`,
         party = ...3,
         votes = ...4,
         vote_share = ...5,
         seats_won = ...9)%>%
  filter(!is.na(vote_share))%>%
  filter(!party == "Feministiskt initiativ") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality))

elections_sweden <- merge(elections_sweden, other, by = c("municipality","party","votes","vote_share"), all = TRUE)
elections_sweden <- elections_sweden %>% arrange(municipality, turnout) %>%
  fill(turnout)
rm(other)

#Seats for national parties        
mandates <- read_html("https://data.val.se/val/val2018/slutresultat/K/rike/valda.html") %>%
  html_table(header = TRUE, fill = TRUE)
mandates <- mandates[[2]] %>% filter(Område != "Sverige") %>%
  gather(party,seats_won,2:10) %>% #Fi!
  rename(municipality = Område,
         mandates = TOT) %>% 
  group_by(municipality) %>%
  mutate(seats_won = ifelse(is.na(seats_won),0,seats_won)) %>%
  arrange(municipality) %>% select(-ÖVR)

#Merge seats and all other election data
local <- merge(elections_sweden,mandates, by = c("municipality", "party"), all = TRUE)
local <- local %>% mutate(seats_won = if_else(is.na(seats_won.x), seats_won.y, seats_won.x))%>%
  select(-seats_won.x, -seats_won.y) %>% arrange(municipality, mandates) %>% 
  fill(mandates)
rm(mandates)

#generate the static variables
local <- local %>% mutate(cname = "Sweden",
                          ccode = "SE",
                          date = "2018-09-09",
                          clevel = "municipality")
#pop data and IDs
local <- merge(local, pop, by = "municipality", all = TRUE)
local <- local %>% select(-`2006`,-`2010`,-`2014`,-`2002`) %>%
  rename(pop = `2018`)
local <- merge(local, ID, by = "municipality", all = TRUE)

#Voter data
voter <- read_excel("Data/scrape_sweden/election_2018.xlsx", 
                    skip = 5) %>% 
  select(municipality = ...1,
         eligible_voters = tigade,
         total_voters = ...3,
         valid_votes = `val-`) %>%
  slice(6:388) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
  filter(municipality %in% ID$municipality)

local <- merge(local,voter, by = "municipality", all = TRUE)
rm(voter)

local <- local %>% group_by(municipality) %>% 
  mutate(seatsCount = ifelse(seats_won == 0, NA, seats_won)) %>%
  mutate(nParties = sum(!is.na(seatsCount))) %>% ungroup()

#reorder and arrange
local <- local %>% select(cname, ccode, date, clevel, turnout, ID,
                          province_ID, province, muni_ID, municipality, pop, eligible_voters, total_voters,
                          valid_votes, party, votes, vote_share, seats_won, mandates, nParties) %>%
  arrange(date, municipality, desc(vote_share))

sweden_plot <- rbind(sweden_plot, local)
rm(local)
rm(elections_sweden)

sweden_plot <- sweden_plot %>%  mutate(party = if_else(party == "FP", "L", party)) %>% select(-cname,-ccode,-clevel)


# 2002 ----------------------------------------------------------------------------------------
#missing local parties
# 2002
elections_sweden <- read_excel("Data/scrape_sweden/2002_votes.xlsx", skip = 3) %>% 
  select(muni_ID = ...1,
         municipality = ...2,
         party = ...3,
         votes = `2002...5`,
         vote_share = `2002...6`) %>%
  fill(muni_ID,municipality) %>%
  slice(1:3201) %>%
  filter(municipality != "Bara")

votes <- elections_sweden %>% group_by(municipality) %>%
  mutate(eligible_voters = sum(votes)) %>%
  filter(party != "VALSKOLKARE") %>% 
  mutate(total_voters = sum(votes)) %>%
  filter(party != "OGILTIGA") %>%
  mutate(valid_votes = sum(votes)) %>%
  mutate(turnout = total_voters/eligible_voters) %>%
  filter(party == "M") %>%
  filter(municipality != "Bara") %>%
  select(muni_ID, municipality, eligible_voters:turnout)

elections_sweden <- merge(elections_sweden, votes, by = c("muni_ID", "municipality"))     
rm(votes)

mandates <- read_excel("Data/scrape_sweden/2002_mandates.xlsx", skip = 1) %>% 
  select(muni_ID = ...1,
         municipality = ...2,
         party = ...3,
         seats_won = `2002`) %>%
  fill(muni_ID,municipality) %>%
  slice(1:2619) %>%
  mutate(seats_won = as.integer(seats_won)) %>%
  group_by(municipality) %>%
  mutate(mandates = sum(seats_won)) %>%
  filter(!is.na(seats_won))

elections_sweden <- merge(elections_sweden, mandates, by = c("muni_ID", "municipality", "party"))
rm(mandates)

elections_sweden <- merge(elections_sweden, pop, by = "municipality", all = TRUE)
elections_sweden <- elections_sweden %>% select(-`2006`,-`2010`,-`2014`,-`2018`) %>%
  rename(pop = `2002`)
elections_sweden <- merge(elections_sweden, ID, by = c("municipality","muni_ID"), all = TRUE)

elections_sweden <- elections_sweden %>%
  mutate(date = "2002-09-15",
         nParties = NA,
         party = if_else(party == "FP", "L", party)) %>%
  select(date, turnout, ID,
         province_ID, province, muni_ID, municipality, pop, eligible_voters, total_voters,
         valid_votes, party, votes, vote_share, seats_won, mandates, nParties)
sweden_plot <- rbind(sweden_plot, elections_sweden)
rm(elections_sweden)

# misc ----------------------------------------------------------------------------------------
sweden_plot <- sweden_plot %>% mutate(turnout = as.numeric(turnout),
                            eligible_voters = as.integer(eligible_voters),
                            valid_votes = as.integer(valid_votes),
                            votes = as.integer(votes),
                            vote_share = as.numeric(vote_share),
                            seats_won = as.integer(seats_won))
```



### filter out groups with too many NAs
```{r}
count_yes <- chairman_des %>% group_by(Kommun) %>% tally(!is.na(Beslut)) %>% rename(yes = n)
count_na <- chairman_des %>% group_by(Kommun) %>% tally(is.na(Beslut)) %>% rename(NAs = n)
count_complete <- bind_cols(count_na, count_yes) %>%  select(-Kommun1) %>% 
  mutate(share_na = (NAs/yes)*100)

#clean environment
rm(count_yes, count_na)

chairman_filter <- count_complete %>% filter(share_na < 20)

chairman_processed <- chairman_des %>% 
  filter(Kommun %in% chairman_filter$Kommun) %>%
  replace_na(list(Nämnd = "Municipality")) %>%
  filter(Nämnd != "Västra hisingen - Individ") %>% # Filter outlier
  group_by(Kommun, year) %>%
  mutate(Beslut = ifelse(is.na(Beslut), round(mean(Beslut, na.rm = T)), Beslut)) %>%
  summarize(Beslut = sum(Beslut)) %>% 
  group_by(Kommun) %>% 
  mutate(has_na = any(is.na(Beslut))) %>%  #Create a variable for filtering NaNs
  ungroup() %>% 
  filter(!has_na) %>%
  select(-has_na)
```

## Majorities other years
Over a lot of other years, SCB has some data quality issues. I have manually edited the excel-file from http://www.statistikdatabasen.scb.se/sq/84393 to remedie all instances in the Chairman filter from the Chairman descision-part of this appendix. The downloadable file is as such different from what is imported here. 
```{r}
majorities <- read_excel("Data/Styren Kommuner, Landsting, Regioner 1994-2018.xlsx", skip = 1) %>%
        select(year = Valår,
               muni_ID = Kod,
               M_part_of_rule = M,
               C_part_of_rule = C,
               L_part_of_rule = `L/FP`,
               KD_part_of_rule = KD,
               S_part_of_rule = S,
               V_part_of_rule = V,
               MP_part_of_rule = MP,
               SD_part_of_rule = SD,
               other_part_of_rule = ÖP
        ) %>% 
        filter(year >= 2002 & year < 2018) %>% 
        mutate(SD_part_of_rule = as.character(SD_part_of_rule)) %>%
        full_join(read_excel("Data/Styre-kommun-updat-2020-02-01.xlsx") %>%
                          mutate(year = 2018) %>%
                          select(year,
                                 muni_ID = Kod,
                                 M_part_of_rule = `2018...3`,
                                 C_part_of_rule = `2018...4`,
                                 L_part_of_rule = `2018...5`,
                                 KD_part_of_rule = `2018...6`,
                                 S_part_of_rule = `2018...7`,
                                 V_part_of_rule = `2018...8`,
                                 MP_part_of_rule = `2018...9`,
                                 SD_part_of_rule = `2018...10`,
                                 other_part_of_rule = `2018...11`,
                                 majority = `Majoritet/minoritet`) %>%
                          mutate(muni_ID = as.numeric(muni_ID))) 
majorities$muni_ID <- str_pad(majorities$muni_ID, 4, side = "left", 0)

majorities <- majorities %>%
        left_join(ID) %>% 
        select(year, muni = municipality, majority, everything(), -ID, -province_ID) %>% 
        mutate(year = as.character(year),
                M_part_of_rule = ifelse(is.na(M_part_of_rule), 0, 1),
                C_part_of_rule = ifelse(is.na(C_part_of_rule), 0, 1),
                L_part_of_rule = ifelse(is.na(L_part_of_rule), 0, 1),
                KD_part_of_rule = ifelse(is.na(KD_part_of_rule), 0, 1),
                S_part_of_rule = ifelse(is.na(S_part_of_rule), 0, 1),
                V_part_of_rule = ifelse(is.na(V_part_of_rule), 0, 1),
                MP_part_of_rule = ifelse(is.na(MP_part_of_rule), 0, 1),
                SD_part_of_rule = ifelse(is.na(SD_part_of_rule), 0, 1),
                other_part_of_rule = ifelse(is.na(other_part_of_rule), 0, 1),
        ) %>%
        left_join(sweden) %>% 
        mutate(majority_dummy = case_when((
                C_part_of_rule*C_seats_won+
                        L_part_of_rule*L_seats_won+
                        KD_part_of_rule*KD_seats_won+
                        MP_part_of_rule*MP_seats_won+
                        M_part_of_rule*M_seats_won+
                        S_part_of_rule*S_seats_won+
                        SD_part_of_rule*SD_seats_won+
                        V_part_of_rule*V_seats_won
        )>= 0.5*total_mandates ~ TRUE)) %>%
        mutate(majority_dummy = ifelse(!is.na(majority_dummy), "Majority", majority_dummy)) %>%
        mutate(majority_dummy = if_else(other_part_of_rule == 0 & is.na(majority_dummy), "Minority", majority_dummy)) %>%
        mutate(majority = ifelse(is.na(majority), majority_dummy, majority)) %>%
        mutate(year = as.numeric(year)) %>%
        left_join(read_excel("Data/Manual_majorities.xlsx") %>% select(year, muni, manual_majority = majority)) %>%
        mutate(majority = ifelse(is.na(majority), manual_majority, majority)) %>%
        select(-majority_dummy, -manual_majority) %>%
  mutate(majority = ifelse(majority == "Majoritet", "Majority", majority),
         majority = ifelse(majority == "Minoritet", "Minority", majority))
  
```

# Merging
```{r}
#Chairman data with majority data
chair_sum <- chair_sum %>% 
  rename(muni = Kommun) %>% 
  left_join(majorities) %>%
  fill(majority:total_mandates)

# Adding population
pop <- read_excel("Data/scrape_sweden/pop_sweden_1950-2019.xlsx", 
                  skip = 5) %>% slice(1:290) %>% select(muni = Kommun,
                                                        `2002`,`2003`,`2004`,`2005`,
                                                        `2006`,`2007`,`2008`,`2009`,
                                                        `2010`,`2011`,`2012`,`2013`,
                                                        `2014`,`2015`,`2016`,`2017`,
                                                        `2018`,`2019`)  %>%
  pivot_longer(2:19, names_to = "year", values_to = "pop")
chair_sum <- chair_sum %>% mutate(year = as.character(year)) %>% left_join(pop)
```

# Modelling
## EDA
```{r Introduction, echo=FALSE}
sweden_plot %>% group_by(date) %>% 
  filter(party == "SD" & seats_won > 0) %>% 
  summarise(SD = n()) %>%
  ggplot(aes(x= date, y= SD)) + 
  geom_bar(stat = "identity") +
  ggtitle("Number of muncipalities where Sweden Democrats had atleast one seat") +
  geom_text(aes(label = SD),nudge_y = 4)

majorities %>% select(muni, year, majority) %>% 
  group_by(year) %>% count(majority)

riksdagspartier <- c("V", "S", "MP", "C", "L", "M", "KD", "SD")
sweden_plot %>% group_by(date) %>% 
  filter(party %in% riksdagspartier & seats_won > 0) %>% 
  count(party) %>%
  mutate(party = fct_relevel(party, riksdagspartier)) %>%
  ggplot(aes(x=date, y=n, group=party)) +
  geom_line(aes(color=party))+
  geom_point(aes(color=party))+
  ggtitle("Number of muncipalities where parties had atleast one seat")

sweden_plot %>% group_by(date, party) %>% 
  filter(party %in% riksdagspartier & seats_won > 0) %>% 
  summarise(total_seats = sum(seats_won)) %>% 
  mutate(party = fct_relevel(party, riksdagspartier)) %>%
  #mandates$party <- factor(mandates$party, levels = riksdagspartier) %>%
  ggplot(aes(x=date, y=total_seats, group=party)) +
  geom_line(aes(color=party))+
  geom_point(aes(color=party))+
  labs(title = "Total municipal seats won",
       x = "Election date",
       y = "Total numer of seats won")
```

```{r Exploratory Graphs}
chair_sum %>%
  ggplot(aes(as.numeric(year), as.numeric(nDes))) +
  geom_point() + 
  geom_smooth(method = "lm") + 
  labs(title = "Bivariate relationship between time and the number of decisions made by the Chairman of the board",
       subtitle = "Outliers removed, values for municipalities with less than 20 % missing data have been imputated using the within group yearly mean",
       y = "Number of descicions")

chair_sum %>%
  mutate(year = as.numeric(year),
         Beslut = as.numeric(nDes)) %>%
  ggplot(aes(year, Beslut, color = majority))+
  geom_point(alpha = 0.4) + 
  geom_smooth(method = "lm", colour = "black") + 
  facet_wrap(~majority) + 
  theme(legend.position = "none") + 
  labs(y = "# of decisions taken by the board chairman",
       title = "Bivariate relationship between time and # of chairman decicions",
       subtitle = "Split into two sets, one where the ruling coalition holds a majority of seats,\none where they only have a minority")
```


```{r, Gothenburg Graphs}
chairman_des %>% 
  filter(Kommun == "Göteborg") %>%
  group_by(Kommun, year) %>%
  mutate(Beslut = ifelse(is.na(Beslut), round(mean(Beslut, na.rm = T)), Beslut)) %>%
  summarise(beslut = sum(Beslut)) %>%
  ggplot(aes(year, beslut))+
  geom_point()

chairman_des %>% 
  filter(Kommun == "Göteborg") %>%
  filter(Nämnd != "Västra hisingen - Individ") %>%
  group_by(Kommun, year) %>%
  mutate(Beslut = ifelse(is.na(Beslut), round(mean(Beslut, na.rm = T)), Beslut)) %>%
  summarise(decisions = sum(Beslut)) %>%
  ggplot(aes(year, decisions))+
  geom_point() +
  geom_smooth(method = "lm") + 
  ggtitle("Number of decisions made by chairman between meetings", "2002-2019, Gothenburg Municipality")


chairman_processed %>% 
  ggplot(aes(S_vote_share))+
  geom_histogram() + 
  labs(title = "S fördelning av valresultat i kommuner, 2002-2002",
       x = "valresultat i procent",
       y="")
```

## Panel modelling
```{r}
library(lmtest)
library(multiwayvcov)
chair_sum <- chair_sum %>%
  mutate(year = as.integer(year)) %>% ungroup()

m1 <- plm(
  nDes ~ majority,
  data = chair_sum,
  model = "within",
  index = c("muni", "year")
)
summary(m1)

coeftest(m1, vcov=vcovHC(m1, type="sss", cluster="group")) 

m1_random <- plm(
  nDes ~ majority,
  data = chair_sum,
  model = "random",
  index = c("muni", "year"))
summary(m1_random)


m2 <- plm(
  nDes ~ nRule + majority+ turnout + total_mandates + pop + province + M_seats_won + C_seats_won + L_seats_won + KD_seats_won + S_seats_won + V_seats_won + MP_seats_won + SD_seats_won + other_seats_won,
  data = chair_sum,
  model = "within",
  index = c("muni", "year"))

m2_random <- plm(
  nDes ~ nRule + majority+ turnout + total_mandates + pop + province + M_seats_won + C_seats_won + L_seats_won + KD_seats_won + S_seats_won + V_seats_won + MP_seats_won + SD_seats_won + other_seats_won,
  data = chair_sum,
  model = "random",
  index = c("muni", "year"))

m3 <- plm(
  nDes ~ nRule+ turnout + majority + total_mandates + pop + province  + C_part_of_rule + L_part_of_rule + KD_part_of_rule + MP_part_of_rule + M_part_of_rule + S_part_of_rule + SD_part_of_rule + V_part_of_rule + nOther,
  data = chair_sum,
  model = "within",
  index = c("muni", "year"))

m3_random <- plm(
  nDes ~ nRule+ turnout + majority + total_mandates + pop + province  + C_part_of_rule + L_part_of_rule + KD_part_of_rule + MP_part_of_rule + M_part_of_rule + S_part_of_rule + SD_part_of_rule + V_part_of_rule + nOther,
  data = chair_sum,
  model = "random",
  index = c("muni", "year"))

m4 <- plm(
  nDes ~ nRule+ turnout + majority + total_mandates + pop + province +  M_vote_share + C_vote_share + L_vote_share + KD_vote_share + S_vote_share + V_vote_share + MP_vote_share + other_vote_share + SD_vote_share,
  data = chair_sum,
  model = "within",
  index = c("muni", "year"))

m4_random <- plm(
  nDes ~ nRule+ turnout + majority + total_mandates + pop + province +  M_vote_share + C_vote_share + L_vote_share + KD_vote_share + S_vote_share + V_vote_share + MP_vote_share + other_vote_share + SD_vote_share,
  data = chair_sum,
  model = "random",
  index = c("muni", "year"))


m5 <- plm(
  nDes ~ nRule + turnout + majority + total_mandates + pop + province + C_part_of_rule + L_part_of_rule + KD_part_of_rule + MP_part_of_rule + 
  M_part_of_rule + S_part_of_rule + SD_part_of_rule + V_part_of_rule + nOther + 
  M_vote_share + C_vote_share + L_vote_share + KD_vote_share + S_vote_share + V_vote_share + MP_vote_share + 
  other_vote_share + SD_vote_share + M_seats_won + C_seats_won + L_seats_won + KD_seats_won + 
  S_seats_won + V_seats_won + MP_seats_won + SD_seats_won + other_seats_won,
  data = chair_sum,
  model = "within",
  index = c("muni", "year"))


library(stargazer)
stargazer(m1,m2,m3,m4,m5, type = "html", out = "./m1.html")
```

### Testing the models
```{r}
phtest(m1, m1_random)
phtest(m2, m2_random)
phtest(m3, m3_random)
phtest(m4, m4_random)
```

