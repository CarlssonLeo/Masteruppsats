---
title: "Master Thesis appendix"
output:
  pdf_document: default
  html_document:
    df_print: paged
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
library(readxl)
library(tidyverse)
library(rvest)
library(haven)
library(lubridate)
library(skimr)
library(plm)
library(broom)
library(GGally)
library(fastDummies)
library(stargazer)
library(lmtest)
library(multiwayvcov)
library(knitr)
library(kableExtra)
library(cowplot)
`%notin%` <- Negate(`%in%`)
Sys.setlocale(locale = "sv_SE.UTF-8")

sequential_years = function(x) {
  accumulate(x, function(total, nxt) ifelse(nxt==0, 0, total+1))
}
```
# Elections
## Scraping election data
```{r Election data, echo=TRUE, message=FALSE, warning=FALSE}

# Data ----------------------------------------------------------------------------------------
ID <- read_excel("Data/scrape_sweden/kommunlankod27.xls", 
                 skip = 5) %>% select(municipality = Name,
                                      ID = Code,
                                      province = ...3,
                                      province_ID = ...5) %>%
  filter(!str_detect(municipality," län")) %>%
  mutate(muni_ID = ID)

# 2006 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2006/slutlig/K/rike/delar.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[1]]
elections_sweden <- elections_sweden %>% 
  arrange(Område) %>% 
  rename(municipality = Område,
         invalid = OG,
         blank = BLANK,
         other = `ÖVR`,
         turnout = VDT) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        rename(V_vote_share = V,
               S_vote_share = S,
               MP_vote_share = MP,
               C_vote_share = C,
               L_vote_share = FP,
               KD_vote_share = KD,
               M_vote_share = M,
               other_vote_share = other)


#Clean away dashes and commas, make data into numeric values 
for(j in 2:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}

#SD
other <- read_excel("Data/scrape_sweden/election_2006.xls", 
                    sheet = "Tabell 9", skip = 6) %>% slice(6:373) %>%
  select(municipality = Kommun,
         party = ...2,
         votes = Antal,
         vote_share = `% av samtliga giltiga röster`,
         seats_won = Totalt) %>%
  filter(!is.na(vote_share)) %>%
  mutate(municipality = if_else(municipality == "Heby2", "Heby", municipality)) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
  mutate(party = if_else(party == "Sverigedemokraterna", "SD", party)) %>%
  mutate(party = if_else(party == "SPI - Sveriges Pensionärers Intresseparti", "SPI", party)) %>% 
  fill(municipality) %>%
        filter(party == "SD") %>% 
        select(municipality,
               SD_vote_share = vote_share,
               -seats_won,-votes,-party)

elections_sweden <- elections_sweden %>% left_join(other) %>% 
        mutate_all(~replace(., is.na(.), 0)) %>%
        mutate(other_vote_share = other_vote_share-SD_vote_share)

#Seats        
mandates <- read_html("https://data.val.se/val/val2006/slutlig_ovrigt/statistik/kommun/mandat_kommun_parti.html") %>%
  html_table(header = TRUE, fill = TRUE) %>%
  first() %>% filter(Kommun != "SUMMA") %>%
  rename(municipality = Kommun,
         mandates = TOT) %>% 
  separate(ÖVR, sep = ", ", into = c("other","other2")) %>% #These could be split into separate rows using gsub and regular expressions
  na_if("") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality),
         other = as.integer(str_extract(other, "[1-9]")),
         other2 = as.integer(str_extract(other2, "[1-9]")),
         SPI = as.integer(SPI)) %>%
        mutate_all(~replace(., is.na(.), 0)) %>%
        mutate(other = other+other2+SPI) %>% 
        select(-other2, - SPI) %>%
        rename(V_seats_won = V,
               S_seats_won = S,
               MP_seats_won = MP,
               C_seats_won = C, 
               L_seats_won = FP,
               KD_seats_won = KD,
               M_seats_won = M,
               SD_seats_won = SD,
               other_seats_won = other,
               total_mandates = mandates) 
election06 <- elections_sweden %>% 
        full_join(mandates) %>% 
        mutate(year = "2006") %>%
        select(year, everything())
sweden <- election06



# 2010 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2010/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[2]]

elections_sweden <- elections_sweden[,c(1,2,4,6,8,10,12,14,16,18,20,22,24)]  %>%
        arrange(Område) %>% 
  rename(municipality = Område,
         invalid = OG,
         blank = BLANK,
         other = `ÖVR`,
         turnout = VDT) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        rename(V_vote_share = V,
               S_vote_share = S,
               MP_vote_share = MP,
               C_vote_share = C,
               L_vote_share = FP,
               KD_vote_share = KD,
               M_vote_share = M,
               SD_vote_share = SD,
               other_vote_share = other) %>% 
  filter(!municipality == "Sverige")

#Clean away dashes and commas, make data into numeric values 
for(j in 2:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}

elections_sweden <- elections_sweden %>% mutate_all(~replace(., is.na(.), 0))


#Seats for national parties        
mandates <- read_html("https://data.val.se/val/val2010/slutresultat/K/rike/valda.html") %>%
  html_table(header = TRUE, fill = TRUE)
mandates <- mandates[[2]] %>% filter(Område != "Sverige")  %>%
rename(municipality = Område,
         mandates = TOT) %>% 
        mutate(other = as.integer(str_extract(ÖVR, "[1-9]"))) %>% #These could be split into separate rows using gsub and regular expressions
  na_if("") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        mutate_all(~replace(., is.na(.), 0)) %>%
        select(-ÖVR) %>%
        rename(V_seats_won = V,
               S_seats_won = S,
               MP_seats_won = MP,
               C_seats_won = C, 
               L_seats_won = FP,
               KD_seats_won = KD,
               M_seats_won = M,
               SD_seats_won = SD,
               other_seats_won = other,
               total_mandates = mandates)

election10 <- elections_sweden %>% 
        full_join(mandates) %>% 
        mutate(year = "2010") %>%
        select(year, everything())
sweden <- rbind(sweden,election10)

# 2014 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2014/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[2]]

elections_sweden <- elections_sweden[,c(1,2,4,6,8,10,12,14,16,18,20,22,24,26)] %>%
        arrange(Område) %>% 
  rename(municipality = Område,
         invalid = OG,
         blank = BLANK,
         other = `ÖVR`,
         turnout = VDT) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        rename(V_vote_share = V,
               S_vote_share = S,
               MP_vote_share = MP,
               C_vote_share = C,
               L_vote_share = FP,
               KD_vote_share = KD,
               M_vote_share = M,
               SD_vote_share = SD,
               other_vote_share = other) %>% 
  filter(!municipality == "Sverige")

#Clean away dashes and commas, make data into numeric values 
for(j in 2:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}

elections_sweden <- elections_sweden %>%
        mutate_all(~replace(., is.na(.), 0)) %>% 
        mutate(other_vote_share = other_vote_share+FI) %>% 
        select(-FI)

#Seats for national parties        
mandates <- read_html("https://data.val.se/val/val2014/slutresultat/K/rike/valda.html") %>%
  html_table(header = TRUE, fill = TRUE)
mandates <- mandates[[2]] %>% filter(Område != "Sverige")  %>%
rename(municipality = Område,
         mandates = TOT) %>% 
        mutate(other = as.integer(str_extract(ÖVR, "[1-9]"))) %>% #These could be split into separate rows using gsub and regular expressions
  na_if("") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        mutate_all(~replace(., is.na(.), 0)) %>%
        select(-ÖVR) %>%
        rename(V_seats_won = V,
               S_seats_won = S,
               MP_seats_won = MP,
               C_seats_won = C, 
               L_seats_won = FP,
               KD_seats_won = KD,
               M_seats_won = M,
               SD_seats_won = SD,
               other_seats_won = other,
               total_mandates = mandates) %>%
        mutate(other_seats_won = other_seats_won+FI) %>% 
        select(-FI)


election14 <- elections_sweden %>% 
        full_join(mandates) %>% 
        mutate(year = "2014") %>%
        select(year, everything())
sweden <- rbind(sweden,election14)

# 2018 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2018/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[2]]
elections_sweden <- elections_sweden[,c(1,2,4,6,8,10,12,14,16,18,20,22,24,26,28)] %>%
        arrange(Område) %>% 
  rename(municipality = Område,
         invalid = OG,
         blank = BLANK,
         other = `ÖVR`,
         turnout = VDT) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        rename(V_vote_share = V,
               S_vote_share = S,
               MP_vote_share = MP,
               C_vote_share = C,
               L_vote_share = L,
               KD_vote_share = KD,
               M_vote_share = M,
               SD_vote_share = SD,
               other_vote_share = other) %>% 
  filter(!municipality == "Sverige")

#Clean away dashes and commas, make data into numeric values 
for(j in 2:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}

elections_sweden <- elections_sweden %>%
        mutate_all(~replace(., is.na(.), 0)) %>% 
        mutate(other_vote_share = other_vote_share+FI,
               invalid = invalid+OGEJ) %>% 
        select(-FI,-OGEJ)


#Seats for national parties        
mandates <- read_html("https://data.val.se/val/val2018/slutresultat/K/rike/valda.html") %>%
  html_table(header = TRUE, fill = TRUE)
mandates <- mandates[[2]] %>% filter(Område != "Sverige") %>%
rename(municipality = Område,
         mandates = TOT) %>% 
        mutate(other = as.integer(str_extract(ÖVR, "[1-9]"))) %>% #These could be split into separate rows using gsub and regular expressions
  na_if("") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
        mutate_all(~replace(., is.na(.), 0)) %>%
        select(-ÖVR) %>%
        rename(V_seats_won = V,
               S_seats_won = S,
               MP_seats_won = MP,
               C_seats_won = C, 
               L_seats_won = L,
               KD_seats_won = KD,
               M_seats_won = M,
               SD_seats_won = SD,
               other_seats_won = other,
               total_mandates = mandates) %>%
        mutate(other_seats_won = other_seats_won+FI) %>% 
        select(-FI)


election18 <- elections_sweden %>% 
        full_join(mandates) %>% 
        mutate(year = "2018") %>%
        select(year, everything())
sweden <- rbind(sweden,election18)



# 2002 ----------------------------------------------------------------------------------------
#missing local parties
# 2002
elections_sweden <- read_excel("Data/scrape_sweden/2002_votes.xlsx", skip = 3) %>% 
  select(muni_ID = ...1,
         municipality = ...2,
         party = ...3,
         votes = `2002...5`,
         vote_share = `2002...6`) %>%
  fill(muni_ID,municipality) %>%
  slice(1:3201) %>%
  filter(municipality != "Bara") 

votes <- elections_sweden %>% group_by(municipality) %>%
  mutate(eligible_voters = sum(votes)) %>%
  filter(party != "VALSKOLKARE") %>% 
  mutate(total_voters = sum(votes)) %>%
  filter(party != "OGILTIGA") %>%
  mutate(valid_votes = sum(votes)) %>%
  mutate(turnout = (total_voters/eligible_voters)*100) %>%
  filter(party == "M") %>%
  filter(municipality != "Bara") %>%
  select(muni_ID, municipality, eligible_voters:turnout) %>%
        select(municipality, turnout)

elections_sweden <- elections_sweden %>% 
        select(-votes,-muni_ID) %>% 
        pivot_wider(names_from = party, values_from = vote_share) %>%
        left_join(votes) %>% 
        rename(V_vote_share = V,
               S_vote_share = S,
               MP_vote_share = MP,
               C_vote_share = C,
               L_vote_share = FP,
               KD_vote_share = KD,
               M_vote_share = M,
               SD_vote_share = SD,
               other_vote_share = ÖVRIGA,
               invalid = OGILTIGA) %>% 
        select(-VALSKOLKARE)
rm(votes)

mandates <- read_excel("Data/scrape_sweden/2002_mandates.xlsx", skip = 1) %>% 
  select(municipality = ...2,
         party = ...3,
         seats_won = `2002`) %>%
  fill(municipality) %>%
  slice(1:2619) %>%
  mutate(seats_won = as.integer(seats_won)) %>%
  group_by(municipality) %>%
  mutate(mandates = sum(seats_won)) %>%
  filter(!is.na(seats_won)) %>% 
        pivot_wider(names_from = party, values_from = seats_won) %>%
        rename(V_seats_won = V,
               S_seats_won = S,
               MP_seats_won = MP,
               C_seats_won = C, 
               L_seats_won = FP,
               KD_seats_won = KD,
               M_seats_won = M,
               SD_seats_won = SD,
               other_seats_won = ÖVRIGA,
               total_mandates = mandates)

election02 <- elections_sweden %>% 
        full_join(mandates) %>% 
        mutate(year = "2002",
               blank = NA) %>%
        select(year, everything())
sweden <- rbind(sweden,election02)

rm(elections_sweden)

sweden <- sweden %>% rename(muni = municipality)

# misc ----------------------------------------------------------------------------------------
procurement <- read_dta("./Data/procurement/bdf_replication.dta")
```

## Clean
```{r}
rm(election02,election06,election10,election14,election18)
```

# Other
## Chairman desiscions
```{r}
chairman_des <- read_excel("Data/Ordförandebeslut.xlsx") %>% filter(!is.na(Kommun)) %>% 
  rename(year = År) %>%
  mutate(Beslut = as.integer(Beslut))

chair_sum <- chairman_des %>% group_by(Kommun, year) %>%  summarise(nDes = sum(Beslut, na.rm = TRUE))
chair_NA <- chairman_des %>% filter(is.na(Beslut))
qplot(chair_NA$year, geom = "histogram",
      binwidth = 1,
      xlab = "Distribution of NAs")

muni_no <- read_excel("Data/Ordförandebeslut.xlsx", sheet = "NEJ", col_names = F) %>% select(denied = `...1`)
muni_no <- unique(muni_no$denied)
muni_yes <- unique(chairman_des$Kommun)
muni_both <- muni_yes[(muni_yes %in% muni_no)]

#Municipalities who gave information
length(muni_yes)

#Municipalities who gave information from some boards, and denied from others
length(muni_both)

#Municipalities who denied
length(muni_no)

muni_reply <- unique(append(muni_yes, muni_no))
290-length(muni_reply)
missing <- ID %>% filter(municipality %notin% muni_reply) %>% arrange(municipality)
missing$municipality
```

## Plot Data
```{r Plot Data, echo=TRUE, message=FALSE, warning=FALSE}
# Data ----------------------------------------------------------------------------------------
# Common
pop <- read_excel("Data/scrape_sweden/pop_sweden_1950-2019.xlsx", 
                  skip = 5) %>% slice(1:290) %>% select(municipality = Kommun,`2002`,`2006`,`2010`,`2014`,`2018`) 
ID <- read_excel("Data/scrape_sweden/kommunlankod27.xls", 
                 skip = 5) %>% select(municipality = Name,
                                      ID = Code,
                                      province = ...3,
                                      province_ID = ...5) %>%
  filter(!str_detect(municipality," län")) %>%
  mutate(muni_ID = ID)


# 2006 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2006/slutlig/K/rike/delar.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[1]]
elections_sweden <- elections_sweden %>% 
  gather(party,vote_share,2:9) %>% 
  arrange(Område) %>% 
  select(municipality = Område,
         party,
         vote_share,
         turnout = VDT) %>%
  filter(!party == "ÖVR") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality))


#Clean away dashes and commas, make data into numeric values 
for(j in 3:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}

other <- read_excel("Data/scrape_sweden/election_2006.xls", 
                    sheet = "Tabell 9", skip = 6) %>% slice(6:373) %>%
  select(municipality = Kommun,
         party = ...2,
         votes = Antal,
         vote_share = `% av samtliga giltiga röster`,
         seats_won = Totalt) %>%
  filter(!is.na(vote_share)) %>%
  mutate(municipality = if_else(municipality == "Heby2", "Heby", municipality)) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
  mutate(party = if_else(party == "Sverigedemokraterna", "SD", party)) %>%
  mutate(party = if_else(party == "SPI - Sveriges Pensionärers Intresseparti", "SPI", party)) %>% 
  fill(municipality)


elections_sweden <- merge(elections_sweden, pop, by = "municipality", all = TRUE)
elections_sweden <- elections_sweden %>% select(-`2010`,-`2014`,-`2018`,-`2002`) %>%
  rename(pop = `2006`)
elections_sweden <- merge(elections_sweden, ID, by = "municipality", all = TRUE)

#Seats        
mandates <- read_html("https://data.val.se/val/val2006/slutlig_ovrigt/statistik/kommun/mandat_kommun_parti.html") %>%
  html_table(header = TRUE, fill = TRUE) %>%
  first() %>% filter(Kommun != "SUMMA") %>%
  gather(party,seats_won,2:11) %>% 
  rename(municipality = Kommun,
         mandates = TOT) %>% 
  separate_rows(seats_won, sep = ", ") %>% #These could be split into separate rows using gsub and regular expressions
  na_if("") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
  group_by(municipality) %>%
  mutate(nParties = sum(!is.na(seats_won))) %>%
  filter(!is.na(seats_won)) %>%
  arrange(municipality)

local <- merge(elections_sweden,mandates, by = c("municipality", "party"), all = TRUE)

local <- local %>% mutate(cname = "Sweden",
                          ccode = "SE",
                          date = "2006-09-17",
                          clevel = "municipality")

voter <- read_excel("Data/scrape_sweden/election_2006.xls", 
                    sheet = "Tabell 7", skip = 5) %>% 
  select(municipality = ...1,
         eligible_voters = ...3,
         total_voters = ...5,
         valid_votes = ...10,
         M=m,C=c,FP=fp,KD=kd,MP=mp,S=s,V=v,ÖVR=övr)%>%
  mutate(municipality = if_else(municipality == "Heby2", "Heby", municipality)) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
  filter(!str_detect(municipality," län")) %>% #NOTE space before län! if not, removes the muni Borlänge
  filter(!is.na(municipality)) %>% 
  filter(municipality != "Hela riket") %>%
  slice(-291:-293) %>%
  gather(party,votes,5:12) %>%
  arrange(municipality)

local <- merge(local,voter, by = c("municipality", "party"), all = TRUE) %>% 
  filter(!party == "SD") %>%
  filter(!party == "ÖVR")
local <- merge(local, other, by = c("municipality","votes","party","vote_share","seats_won"), all = TRUE) %>% 
  arrange(municipality, turnout)
local <- local %>% mutate(seats_won = ifelse(is.na(seats_won), 0, seats_won)) %>% 
  fill(turnout:valid_votes) %>% 
  select(cname, ccode, date, clevel, turnout, ID,
         province_ID, province, muni_ID, municipality, pop, eligible_voters, total_voters,
         valid_votes, party, votes, vote_share, seats_won, mandates, nParties) %>%
  arrange(date, municipality, desc(vote_share))

sweden_plot <- local



# 2010 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2010/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[2]]

elections_sweden <- elections_sweden[,c(1,2,4,6,8,10,12,14,16,18,20,22,24)] %>%
  gather(party,vote_share, 2:9) %>%
  arrange(Område) %>% 
  select(municipality = Område,
         party,
         vote_share,
         turnout = VDT) %>% 
  filter(!municipality == "Sverige")


votes <- read_html("https://data.val.se/val/val2010/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
votes <- votes[[2]]
votes <- votes[,c(1,3,5,7,9,11,13,15,17)] %>%
  gather(party,votes, 2:9) %>%
  rename(municipality = Område)%>% 
  filter(!municipality == "Sverige")
elections_sweden <- merge(elections_sweden, votes, by = c("municipality", "party"))

#Clean away dashes and commas, make data into numeric values 
for(j in 3:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}

#Getting the non-national parties
other <- read_excel("Data/scrape_sweden/election_2010.xls", 
                    sheet = "Tabell 11", skip = 11) %>%
  select(municipality = `Stockholms län`,
         party = ...3,
         votes = ...4,
         vote_share = ...5,
         seats_won = ...9)%>%
  filter(!is.na(vote_share)) %>%
  fill(municipality) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality))

elections_sweden <- merge(elections_sweden, other, by = c("municipality","party","votes","vote_share"), all = TRUE)
elections_sweden <- elections_sweden %>% arrange(municipality, turnout) %>%
  fill(turnout)

#Seats for national parties        
mandates <- read_html("https://data.val.se/val/val2010/slutresultat/K/rike/valda.html") %>%
  html_table(header = TRUE, fill = TRUE)
mandates <- mandates[[2]] %>% filter(Område != "Sverige") %>%
  gather(party,seats_won,2:9) %>% 
  rename(municipality = Område,
         mandates = TOT) %>% 
  group_by(municipality) %>%
  mutate(nParties = sum(!is.na(seats_won))) %>%
  mutate(seats_won = ifelse(is.na(seats_won),0,seats_won)) %>%
  arrange(municipality) %>% select(-ÖVR)

#Merge seats and all other election data
local <- merge(elections_sweden,mandates, by = c("municipality", "party"), all = TRUE)
local <- local %>% mutate(seats_won = if_else(is.na(seats_won.x), seats_won.y, seats_won.x))%>%
  select(-seats_won.x, -seats_won.y) %>% arrange(municipality, mandates) %>%
  fill(mandates:nParties)


#generate the static variables
local <- local %>% mutate(cname = "Sweden",
                          ccode = "SE",
                          date = "2010-09-19",
                          clevel = "municipality")
#pop data and IDs
local <- merge(local, pop, by = "municipality", all = TRUE)
local <- local %>% select(-`2006`,-`2014`,-`2018`,-`2002`) %>%
  rename(pop = `2010`)
local <- merge(local, ID, by = "municipality", all = TRUE)

#Voter data
voter <- read_excel("Data/scrape_sweden/election_2010.xls", 
                    sheet = "Tabell 9", skip = 5) %>% 
  select(municipality = ...1,
         eligible_voters = `berät-`,
         total_voters = ...5,
         valid_votes = giltiga) %>%
  slice(7:336) %>%
  filter(!str_detect(municipality," län")) %>% #NOTE space before län! if not, removes the muni Borlänge
  filter(!is.na(municipality)) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality))

local <- merge(local,voter, by = "municipality", all = TRUE)

#reorder and arrange
local <- local %>% select(cname, ccode, date, clevel, turnout, ID,
                          province_ID, province, muni_ID, municipality, pop, eligible_voters, total_voters,
                          valid_votes, party, votes, vote_share, seats_won, mandates, nParties) %>%
  arrange(date, municipality, desc(vote_share))

sweden_plot <- rbind(sweden_plot, local)


# 2014 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2014/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[2]]

elections_sweden <- elections_sweden[,c(1,2,4,6,8,10,12,14,16,18,20,22,24,26)] %>%
  gather(party,vote_share, 2:10) %>%
  arrange(Område) %>% 
  select(municipality = Område,
         party,
         vote_share,
         turnout = VDT)%>% 
  filter(!municipality == "Sverige")

votes <- read_html("https://data.val.se/val/val2014/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
votes <- votes[[2]]
votes <- votes[,c(1,3,5,7,9,11,13,15,17,19)] %>%
  gather(party,votes, 2:10) %>% #Fi!
  rename(municipality = Område) %>% 
  filter(!municipality == "Sverige")

elections_sweden <- merge(elections_sweden, votes, by = c("municipality", "party"))
rm(votes)

#Clean away dashes and commas, make data into numeric values 
for(j in 3:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}
rm(j)

#Getting the non-national parties
other <- read_excel("Data/scrape_sweden/election_2014.xlsx", 
                    sheet = "Tabell 11", skip = 11) %>%
  select(municipality = `Stockholms län`,
         party = ...3,
         votes = ...4,
         vote_share = ...5,
         seats_won = ...9)%>%
  filter(!is.na(vote_share)) %>% 
  filter(!party == "Feministiskt initiativ")%>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality))

elections_sweden <- merge(elections_sweden, other, by = c("municipality","party","votes","vote_share"), all = TRUE)
elections_sweden <- elections_sweden %>% arrange(municipality, turnout) %>%
  fill(turnout)
rm(other)

#Seats for national parties        
mandates <- read_html("https://data.val.se/val/val2014/slutresultat/K/rike/valda.html") %>%
  html_table(header = TRUE, fill = TRUE)
mandates <- mandates[[2]] %>% filter(Område != "Sverige") %>%
  gather(party,seats_won,2:10) %>% #Fi!
  rename(municipality = Område,
         mandates = TOT) %>% 
  group_by(municipality) %>%
  mutate(nParties = sum(!is.na(seats_won))) %>%
  mutate(seats_won = ifelse(is.na(seats_won),0,seats_won)) %>%
  arrange(municipality) %>% select(-ÖVR)

#Merge seats and all other election data
local <- merge(elections_sweden,mandates, by = c("municipality", "party"), all = TRUE)
local <- local %>% mutate(seats_won = if_else(is.na(seats_won.x), seats_won.y, seats_won.x))%>%
  select(-seats_won.x, -seats_won.y) %>% arrange(municipality, mandates) %>%
  fill(mandates:nParties)
rm(mandates)

#generate the static variables
local <- local %>% mutate(cname = "Sweden",
                          ccode = "SE",
                          date = "2014-09-14",
                          clevel = "municipality")
#pop data and IDs
local <- merge(local, pop, by = "municipality", all = TRUE)
local <- local %>% select(-`2006`,-`2010`,-`2018`,-`2002`) %>%
  rename(pop = `2014`)
local <- merge(local, ID, by = "municipality", all = TRUE)

#Voter data
voter <- read_excel("Data/scrape_sweden/election_2014.xlsx", 
                    sheet = "Tabell 9", skip = 5) %>% 
  select(municipality = ...1,
         eligible_voters = `berät-`,
         total_voters = ...3,
         valid_votes = giltiga) %>%
  slice(7:336) %>%
  filter(!str_detect(municipality," län")) %>% #NOTE space before län! if not, removes the muni Borlänge
  filter(!is.na(municipality)) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality))

local <- merge(local,voter, by = "municipality", all = TRUE)
rm(voter)

#reorder and arrange
local <- local %>% select(cname, ccode, date, clevel, turnout, ID,
                          province_ID, province, muni_ID, municipality, pop, eligible_voters, total_voters,
                          valid_votes, party, votes, vote_share, seats_won, mandates, nParties) %>%
  arrange(date, municipality, desc(vote_share))

sweden_plot <- rbind(sweden_plot, local)


# 2018 ----------------------------------------------------------------------------------------
# Import
elections_sweden <- read_html("https://data.val.se/val/val2018/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
elections_sweden <- elections_sweden[[2]]
elections_sweden <- elections_sweden[,c(1,2,4,6,8,10,12,14,16,18,20,22,24,26,28)] %>%
  gather(party,vote_share, 2:10) %>%
  arrange(Område) %>% 
  select(municipality = Område,
         party,
         vote_share,
         turnout = VDT)%>% 
  filter(!municipality == "Sverige")

votes <- read_html("https://data.val.se/val/val2018/slutresultat/K/rike/index.html") %>%
  html_table(header = TRUE, fill = TRUE)
votes <- votes[[2]]
votes <- votes[,c(1,3,5,7,9,11,13,15,17,19)] %>%
  gather(party,votes, 2:10) %>% #Fi!
  rename(municipality = Område)%>% 
  filter(!municipality == "Sverige")
elections_sweden <- merge(elections_sweden, votes, by = c("municipality", "party"))
rm(votes)

#Clean away dashes and commas, make data into numeric values 
for(j in 3:ncol(elections_sweden)){
  elections_sweden[,j]=sub("%", "", elections_sweden[,j], fixed = TRUE)
  elections_sweden[,j]=as.numeric(sub(",", ".", elections_sweden[,j], fixed = TRUE))
}
rm(j)

#Getting the non-national parties
other <- read_excel("Data/scrape_sweden/other_2018.xlsx", skip = 11) %>%
  select(municipality = `Stockholms län`,
         party = ...3,
         votes = ...4,
         vote_share = ...5,
         seats_won = ...9)%>%
  filter(!is.na(vote_share))%>%
  filter(!party == "Feministiskt initiativ") %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality))

elections_sweden <- merge(elections_sweden, other, by = c("municipality","party","votes","vote_share"), all = TRUE)
elections_sweden <- elections_sweden %>% arrange(municipality, turnout) %>%
  fill(turnout)
rm(other)

#Seats for national parties        
mandates <- read_html("https://data.val.se/val/val2018/slutresultat/K/rike/valda.html") %>%
  html_table(header = TRUE, fill = TRUE)
mandates <- mandates[[2]] %>% filter(Område != "Sverige") %>%
  gather(party,seats_won,2:10) %>% #Fi!
  rename(municipality = Område,
         mandates = TOT) %>% 
  group_by(municipality) %>%
  mutate(seats_won = ifelse(is.na(seats_won),0,seats_won)) %>%
  arrange(municipality) %>% select(-ÖVR)

#Merge seats and all other election data
local <- merge(elections_sweden,mandates, by = c("municipality", "party"), all = TRUE)
local <- local %>% mutate(seats_won = if_else(is.na(seats_won.x), seats_won.y, seats_won.x))%>%
  select(-seats_won.x, -seats_won.y) %>% arrange(municipality, mandates) %>% 
  fill(mandates)
rm(mandates)

#generate the static variables
local <- local %>% mutate(cname = "Sweden",
                          ccode = "SE",
                          date = "2018-09-09",
                          clevel = "municipality")
#pop data and IDs
local <- merge(local, pop, by = "municipality", all = TRUE)
local <- local %>% select(-`2006`,-`2010`,-`2014`,-`2002`) %>%
  rename(pop = `2018`)
local <- merge(local, ID, by = "municipality", all = TRUE)

#Voter data
voter <- read_excel("Data/scrape_sweden/election_2018.xlsx", 
                    skip = 5) %>% 
  select(municipality = ...1,
         eligible_voters = tigade,
         total_voters = ...3,
         valid_votes = `val-`) %>%
  slice(6:388) %>%
  mutate(municipality = if_else(municipality == "Malung", "Malung-Sälen",municipality)) %>%
  filter(municipality %in% ID$municipality)

local <- merge(local,voter, by = "municipality", all = TRUE)
rm(voter)

local <- local %>% group_by(municipality) %>% 
  mutate(seatsCount = ifelse(seats_won == 0, NA, seats_won)) %>%
  mutate(nParties = sum(!is.na(seatsCount))) %>% ungroup()

#reorder and arrange
local <- local %>% select(cname, ccode, date, clevel, turnout, ID,
                          province_ID, province, muni_ID, municipality, pop, eligible_voters, total_voters,
                          valid_votes, party, votes, vote_share, seats_won, mandates, nParties) %>%
  arrange(date, municipality, desc(vote_share))

sweden_plot <- rbind(sweden_plot, local)
rm(local)
rm(elections_sweden)

sweden_plot <- sweden_plot %>%  mutate(party = if_else(party == "FP", "L", party)) %>% select(-cname,-ccode,-clevel)


# 2002 ----------------------------------------------------------------------------------------
#missing local parties
# 2002
elections_sweden <- read_excel("Data/scrape_sweden/2002_votes.xlsx", skip = 3) %>% 
  select(muni_ID = ...1,
         municipality = ...2,
         party = ...3,
         votes = `2002...5`,
         vote_share = `2002...6`) %>%
  fill(muni_ID,municipality) %>%
  slice(1:3201) %>%
  filter(municipality != "Bara")

votes <- elections_sweden %>% group_by(municipality) %>%
  mutate(eligible_voters = sum(votes)) %>%
  filter(party != "VALSKOLKARE") %>% 
  mutate(total_voters = sum(votes)) %>%
  filter(party != "OGILTIGA") %>%
  mutate(valid_votes = sum(votes)) %>%
  mutate(turnout = total_voters/eligible_voters) %>%
  filter(party == "M") %>%
  filter(municipality != "Bara") %>%
  select(muni_ID, municipality, eligible_voters:turnout)

elections_sweden <- merge(elections_sweden, votes, by = c("muni_ID", "municipality"))     
rm(votes)

mandates <- read_excel("Data/scrape_sweden/2002_mandates.xlsx", skip = 1) %>% 
  select(muni_ID = ...1,
         municipality = ...2,
         party = ...3,
         seats_won = `2002`) %>%
  fill(muni_ID,municipality) %>%
  slice(1:2619) %>%
  mutate(seats_won = as.integer(seats_won)) %>%
  group_by(municipality) %>%
  mutate(mandates = sum(seats_won)) %>%
  filter(!is.na(seats_won))

elections_sweden <- merge(elections_sweden, mandates, by = c("muni_ID", "municipality", "party"))
rm(mandates)

elections_sweden <- merge(elections_sweden, pop, by = "municipality", all = TRUE)
elections_sweden <- elections_sweden %>% select(-`2006`,-`2010`,-`2014`,-`2018`) %>%
  rename(pop = `2002`)
elections_sweden <- merge(elections_sweden, ID, by = c("municipality","muni_ID"), all = TRUE)

elections_sweden <- elections_sweden %>%
  mutate(date = "2002-09-15",
         nParties = NA,
         party = if_else(party == "FP", "L", party)) %>%
  select(date, turnout, ID,
         province_ID, province, muni_ID, municipality, pop, eligible_voters, total_voters,
         valid_votes, party, votes, vote_share, seats_won, mandates, nParties)
sweden_plot <- rbind(sweden_plot, elections_sweden)
rm(elections_sweden)

# misc ----------------------------------------------------------------------------------------
sweden_plot <- sweden_plot %>% mutate(turnout = as.numeric(turnout),
                            eligible_voters = as.integer(eligible_voters),
                            valid_votes = as.integer(valid_votes),
                            votes = as.integer(votes),
                            vote_share = as.numeric(vote_share),
                            seats_won = as.integer(seats_won))
```



### filter out groups with too many NAs
```{r}
count_yes <- chairman_des %>% group_by(Kommun) %>% tally(!is.na(Beslut)) %>% rename(yes = n)
count_na <- chairman_des %>% group_by(Kommun) %>% tally(is.na(Beslut)) %>% rename(NAs = n)
count_complete <- bind_cols(count_na, count_yes) %>%  select(-Kommun1) %>% 
  mutate(share_na = (NAs/yes)*100)

#clean environment
rm(count_yes, count_na)

chairman_filter <- count_complete %>% filter(share_na < 20)

chairman_processed <- chairman_des %>% 
  filter(Kommun %in% chairman_filter$Kommun) %>%
  replace_na(list(Nämnd = "Municipality")) %>%
  filter(Nämnd != "Västra hisingen - Individ") %>% # Filter outlier
  group_by(Kommun, year) %>%
  mutate(Beslut = ifelse(is.na(Beslut), round(mean(Beslut, na.rm = T)), Beslut)) %>%
  summarize(Beslut = sum(Beslut)) %>% 
  group_by(Kommun) %>% 
  mutate(has_na = any(is.na(Beslut))) %>%  #Create a variable for filtering NaNs
  ungroup() %>% 
  filter(!has_na) %>%
  select(-has_na)
```

## Majorities other years
Over a lot of other years, SCB has some data quality issues. I have manually edited the excel-file from http://www.statistikdatabasen.scb.se/sq/84393 to remedie all instances in the Chairman filter from the Chairman descision-part of this appendix. The downloadable file is as such different from what is imported here. 
```{r}
majorities <- read_excel("Data/Styren Kommuner, Landsting, Regioner 1994-2018.xlsx", skip = 1) %>%
        select(year = Valår,
               muni_ID = Kod,
               M_part_of_rule = M,
               C_part_of_rule = C,
               L_part_of_rule = `L/FP`,
               KD_part_of_rule = KD,
               S_part_of_rule = S,
               V_part_of_rule = V,
               MP_part_of_rule = MP,
               SD_part_of_rule = SD,
               other_part_of_rule = ÖP
        ) %>% 
        filter(year >= 2002 & year < 2018) %>% 
        mutate(SD_part_of_rule = as.character(SD_part_of_rule)) %>%
        full_join(read_excel("Data/Styre-kommun-updat-2020-02-01.xlsx") %>%
                          mutate(year = 2018) %>%
                          select(year,
                                 muni_ID = Kod,
                                 M_part_of_rule = `2018...3`,
                                 C_part_of_rule = `2018...4`,
                                 L_part_of_rule = `2018...5`,
                                 KD_part_of_rule = `2018...6`,
                                 S_part_of_rule = `2018...7`,
                                 V_part_of_rule = `2018...8`,
                                 MP_part_of_rule = `2018...9`,
                                 SD_part_of_rule = `2018...10`,
                                 other_part_of_rule = `2018...11`,
                                 majority = `Majoritet/minoritet`) %>%
                          mutate(muni_ID = as.numeric(muni_ID))) %>%
  ungroup() %>%
  mutate(muni_ID = str_pad(muni_ID, width =  4, side = "left", pad = 0))%>%
        left_join(ID) %>% 
        select(year, muni = municipality, majority, everything(), -ID, -province_ID) %>% 
        mutate(year = as.character(year),
                M_part_of_rule = ifelse(is.na(M_part_of_rule), 0, 1),
                C_part_of_rule = ifelse(is.na(C_part_of_rule), 0, 1),
                L_part_of_rule = ifelse(is.na(L_part_of_rule), 0, 1),
                KD_part_of_rule = ifelse(is.na(KD_part_of_rule), 0, 1),
                S_part_of_rule = ifelse(is.na(S_part_of_rule), 0, 1),
                V_part_of_rule = ifelse(is.na(V_part_of_rule), 0, 1),
                MP_part_of_rule = ifelse(is.na(MP_part_of_rule), 0, 1),
                SD_part_of_rule = ifelse(is.na(SD_part_of_rule), 0, 1),
                other_part_of_rule = ifelse(is.na(other_part_of_rule), 0, 1),
        ) %>%
        left_join(sweden) %>% 
        mutate(majority_dummy = case_when((
                C_part_of_rule*C_seats_won+
                        L_part_of_rule*L_seats_won+
                        KD_part_of_rule*KD_seats_won+
                        MP_part_of_rule*MP_seats_won+
                        M_part_of_rule*M_seats_won+
                        S_part_of_rule*S_seats_won+
                        SD_part_of_rule*SD_seats_won+
                        V_part_of_rule*V_seats_won
        )>= 0.5*total_mandates ~ TRUE)) %>%
        mutate(majority_dummy = ifelse(!is.na(majority_dummy), "Majority", majority_dummy)) %>%
        mutate(majority_dummy = if_else(other_part_of_rule == 0 & is.na(majority_dummy), "Minority", majority_dummy)) %>%
        mutate(majority = ifelse(is.na(majority), majority_dummy, majority)) %>%
        mutate(year = as.numeric(year)) %>%
        left_join(read_excel("Data/Manual_majorities.xlsx") %>% select(year, muni, manual_majority = majority)) %>%
        mutate(majority = ifelse(is.na(majority), manual_majority, majority)) %>%
        select(-majority_dummy, -manual_majority) %>%
  mutate(majority = ifelse(majority == "Majoritet", "Majority", majority),
         majority = ifelse(majority == "Minoritet", "Minority", majority)) %>%
  mutate(V_length = sequential_years(V_part_of_rule),
    S_length = sequential_years(S_part_of_rule),
    MP_length = sequential_years(MP_part_of_rule),
    C_length = sequential_years(C_part_of_rule),
    L_length = sequential_years(L_part_of_rule),
    M_length = sequential_years(M_part_of_rule),
    KD_length = sequential_years(KD_part_of_rule),
    SD_length = sequential_years(SD_part_of_rule),
    other_length = sequential_years(other_part_of_rule)) %>%
  left_join(read_excel("Data/Styren Kommuner, Landsting, Regioner 1994-2018.xlsx", skip = 1) %>%
  select(year = Valår,
        muni_ID = Kod,
        nOther = `Övrigt parti, ange vilket eller vilka`) %>%
  filter(year >= 2002 & year < 2018) %>%
  separate_rows(nOther, sep = ", ") %>%
  na_if("") %>%
  group_by(muni_ID, year) %>%
  summarise(nOther = sum(!is.na(nOther))) %>% 
  ungroup() %>%
  mutate(muni_ID = str_pad(muni_ID, width =  4, side = "left", pad = 0))) %>%
  mutate(nRule = nOther+M_part_of_rule+C_part_of_rule+L_part_of_rule+KD_part_of_rule+S_part_of_rule+V_part_of_rule +MP_part_of_rule +SD_part_of_rule)
```

# Merging
```{r}
#Chairman data with majority data
chair_sum <- chair_sum %>% 
  rename(muni = Kommun) %>% 
  left_join(majorities) %>%
  fill(majority:nRule)

# Adding population
pop <- read_excel("Data/scrape_sweden/pop_sweden_1950-2019.xlsx", 
                  skip = 5) %>% slice(1:290) %>% select(muni = Kommun,
                                                        `2002`,`2003`,`2004`,`2005`,
                                                        `2006`,`2007`,`2008`,`2009`,
                                                        `2010`,`2011`,`2012`,`2013`,
                                                        `2014`,`2015`,`2016`,`2017`,
                                                        `2018`,`2019`)  %>%
  pivot_longer(2:19, names_to = "year", values_to = "pop")

chair_sum <- chair_sum %>% 
  mutate(year = as.character(year)) %>% 
  left_join(pop) %>%
  left_join(read_csv("http://www.statistikdatabasen.scb.se/sq/85687", 
                   locale = locale(encoding = "latin1"), 
                   col_names = TRUE ) %>%
  separate(region, into = c("muni_ID", "muni"), sep = " ", extra = "merge") %>%
  select(muni, 23:39) %>%
  rename(`2002` = `Medianinkomst, tkr 2002`,
         `2003` = `Medianinkomst, tkr 2003`,
         `2004` = `Medianinkomst, tkr 2004`,
         `2005` = `Medianinkomst, tkr 2005`,
         `2006` = `Medianinkomst, tkr 2006`,
         `2007` = `Medianinkomst, tkr 2007`,
         `2008` = `Medianinkomst, tkr 2008`,
         `2009` = `Medianinkomst, tkr 2009`,
         `2010` = `Medianinkomst, tkr 2010`,
         `2011` = `Medianinkomst, tkr 2011`,
         `2012` = `Medianinkomst, tkr 2012`,
         `2013` = `Medianinkomst, tkr 2013`,
         `2014` = `Medianinkomst, tkr 2014`,
         `2015` = `Medianinkomst, tkr 2015`,
         `2016` = `Medianinkomst, tkr 2016`,
         `2017` = `Medianinkomst, tkr 2017`,
         `2018` = `Medianinkomst, tkr 2018`) %>%
  mutate(`2019` =`2018`) %>%
  pivot_longer(`2002`:`2019`, names_to = "year", values_to = "median_income"))

```

# Modelling
## EDA
```{r Introduction, echo=FALSE}
#in paper
majorities %>% count(majority, year) %>% 
  ggplot(aes(factor(year), n, fill = majority))+
  geom_col()+
  labs(x = "Year",
       y = "Count",
       title = "Number of majorities and minorities after each election year",
       subtitle = "NA = data unavailable for that municipality")

majorities_table <- majorities %>% count(majority, year) %>% pivot_wider(names_from = majority, values_from = n)
stargazer(as.data.frame(majorities_table), summary = F, type = "html", out = "./majorities_table.html")

#in paper
sweden_plot %>% group_by(date) %>% 
  filter(party == "SD" & seats_won > 0) %>% 
  summarise(SD = n()) %>%
  ggplot(aes(x= date, y= SD)) + 
  geom_bar(stat = "identity") +
  ggtitle("Number of muncipalities where Sweden Democrats had atleast one seat") +
  geom_text(aes(label = SD),nudge_y = 4)

majorities %>% select(muni, year, majority) %>% 
  group_by(year) %>% count(majority)

#in paper
riksdagspartier <- c("V", "S", "MP", "C", "L", "M", "KD", "SD")
sweden_plot %>% group_by(date) %>% 
  filter(party %in% riksdagspartier & seats_won > 0) %>% 
  count(party) %>%
  mutate(party = fct_relevel(party, riksdagspartier)) %>%
  ggplot(aes(x=date, y=n, group=party)) +
  geom_line(aes(color=party))+
  geom_point(aes(color=party))+
  ggtitle("Number of muncipalities where parties had atleast one seat")

sweden_plot %>% group_by(date, party) %>% 
  filter(party %in% riksdagspartier & seats_won > 0) %>% 
  summarise(total_seats = sum(seats_won)) %>% 
  mutate(party = fct_relevel(party, riksdagspartier)) %>%
  #mandates$party <- factor(mandates$party, levels = riksdagspartier) %>%
  ggplot(aes(x=date, y=total_seats, group=party)) +
  geom_line(aes(color=party))+
  geom_point(aes(color=party))+
  labs(title = "Total municipal seats won",
       x = "Election date",
       y = "Total numer of seats won")

response <- ID %>% count(province, name = "Sweden") %>% 
  left_join(primary %>% 
              select(muni, province) %>% 
              distinct() %>% 
              count(province, name = "sample")) %>%
  mutate(share = sample/Sweden)
stargazer(as.data.frame(response), summary = FALSE, type = "html", out = "./response.html")


```

```{r Exploratory Graphs in paper}
chair_sum %>%
  ungroup () %>%
  count(majority, year) %>%
  ggplot(aes(year, n, fill = majority)) +
  geom_bar(stat= "identity")+
  labs(title = "Number of majorities and minorities within sample",
       y = "Count",
       x = "Year")
  

chair_sum %>%
  mutate(year = as.numeric(year),
         Beslut = as.numeric(nDes)) %>%
  ggplot(aes(year, Beslut, color = majority))+
  geom_point(alpha = 0.4) + 
  geom_smooth(method = "lm", colour = "black") + 
  facet_wrap(~majority) + 
  theme(legend.position = "none") + 
  labs(y = "# of decisions taken by the board chairman",
       title = "Bivariate relationship between time and # of chairman decicions",
       subtitle = "Split into two sets, one where the ruling coalition holds a majority of seats, one where they only have a minority")
```



```{r, Summary Statistics}
primary <- chair_sum %>%
  mutate(year = as.integer(year),
         M_vote_share = as.numeric(M_vote_share),
         C_vote_share = as.numeric(C_vote_share),
         L_vote_share = as.numeric(L_vote_share),
         KD_vote_share = as.numeric(KD_vote_share),
         S_vote_share = as.numeric(S_vote_share),
         V_vote_share = as.numeric(V_vote_share),
         MP_vote_share = as.numeric(MP_vote_share),
         SD_vote_share = as.numeric(SD_vote_share),
         other_vote_share = as.numeric(other_vote_share),
         invalid = as.numeric(invalid),
         majority = as.factor(majority),
         nRule = as.integer(nRule)) %>% ungroup() %>% select(-blank, -invalid)
stargazer(as.data.frame(primary), type = "html", out = "./summary.html")

#Chairman decisions, with and without log
des1 <- chair_sum %>% ggplot(aes(nDes)) + 
  geom_histogram()+
  labs(x = "Chairman decisions",
       y = "")
des2 <- primary %>% ggplot(aes(nDes)) + 
  geom_histogram()+
  labs(x = "log Chairman decisions",
       y = "")
#in paper
plot_grid(des1, des2,
          labels = c("A", "B"))

# density plot for all varibles
primary %>% 
  keep(is.numeric) %>%
  gather() %>%
  filter(!str_detect(key, "part_of_rule"),
         !str_detect(key, "_length"),
         key != "year") %>%
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_density()


income1 <- primary %>% ggplot(aes(median_income)) + 
  geom_density()+
  labs(x = "Median Income",
       y = "")
income2 <- primary %>% ggplot(aes(log(median_income))) + 
  geom_density()+
  labs(x = "log Median Income",
       y = "")
pop1 <- primary %>% ggplot(aes(pop)) + 
  geom_density()+
  labs(x = "Population",
       y = "")
pop2 <- primary %>% ggplot(aes(log(pop))) + 
  geom_density()+
  labs(x = "log Population",
       y = "")
#in paper
plot_grid(income1, income2, pop1, pop2,
          labels = c("A", "B", "C", "D"))

```


## Panel modelling
```{r Primary}
#Data:
avg_data <- primary %>% 
  mutate(mandate_period = if_else(year >= 2002 & year < 2006, 1, 0),
         mandate_period = if_else(year >= 2006 & year < 2010, 2, mandate_period),
         mandate_period = if_else(year >= 2010 & year < 2014, 3, mandate_period),
         mandate_period = if_else(year >= 2014 & year < 2018, 4, mandate_period),
         mandate_period = if_else(year >= 2018, 5, mandate_period),
         minority_dummy = if_else(majority == "Minority", 1, 0)
         ) %>% 
  group_by(muni, mandate_period) %>% 
  mutate(des_avg = mean(nDes),
         pop = mean(pop),
         median_income = mean(median_income)) %>% 
  ungroup() %>%
  select(-nDes, -year) %>% 
  unique()

des1 <- avg_data %>% ggplot(aes(des_avg)) + 
  geom_histogram()+
  labs(x = "Average Chairman decisions",
       y = "")
des2 <- avg_data %>% ggplot(aes(log(des_avg))) + 
  geom_histogram()+
  labs(x = "log Average Chairman decisions",
       y = "")
#in paper
plot_grid(des1, des2,
          labels = c("A", "B"))

diff_data <- avg_data %>% filter(mandate_period == 2 | mandate_period == 3)

ols_data <- avg_data %>% filter(mandate_period == 5)

#Models:
bi_avg <- plm(
  log(des_avg+1) ~ minority_dummy,
  data = avg_data,
  model = "within",
  effect = "individual",
  index = c("muni", "mandate_period"))

avg <- plm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share ,
  data = avg_data,
  model = "within",
  effect = "individual",
  index = c("muni", "mandate_period"))

diff <- plm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share ,
  data = diff_data,
  model = "within",
  effect = "individual",
  index = c("muni", "mandate_period"))


ols <- lm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share,
  data = ols_data)

gmm <- pgmm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share | lag(log(des_avg+1), 2:5),
  effect = "individual",
  model = "twosteps",
  transformation = "ld",
  data = avg_data,
  index = c("muni", "mandate_period"))
summary(gmm)

gmm_diff <- pgmm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share | lag(log(des_avg+1), 2:5),
  effect = "individual",
  model = "onestep",
  transformation = "d",
  data = avg_data,
  index = c("muni", "mandate_period"))

se <- list(sqrt(diag(vcovHC(bi_avg, type = "HC3"))),
              sqrt(diag(vcovHC(avg, type = "HC3"))),
              sqrt(diag(vcovHC(diff, type = "HC3"))),
              sqrt(diag(vcovHC(ols))),
              sqrt(diag(vcovHC(gmm)))
           )

stargazer(bi_avg, avg, diff, ols, gmm,
          se = se,
          model.names = TRUE,
          multicolumn = TRUE,
          notes = "Municipality Clustered Standard Error in Parenthesis",
          type = "html",
          out = "./Regressions/Table.html")

pwartest(bi_avg)
pwartest(avg)
pwartest(diff)
```

## Robustness
```{r Imputed}
#Chairman data with majority data
chairman_processed <- chairman_processed %>% 
  rename(muni = Kommun) %>% 
  left_join(majorities) %>%
  fill(majority:nRule)

chairman_processed <- chairman_processed %>% 
  mutate(year = as.character(year)) %>% 
  left_join(pop) %>%
  left_join(read_csv("http://www.statistikdatabasen.scb.se/sq/85687", 
                   locale = locale(encoding = "latin1"), 
                   col_names = TRUE ) %>%
  separate(region, into = c("muni_ID", "muni"), sep = " ", extra = "merge") %>%
  select(muni, 23:39) %>%
  rename(`2002` = `Medianinkomst, tkr 2002`,
         `2003` = `Medianinkomst, tkr 2003`,
         `2004` = `Medianinkomst, tkr 2004`,
         `2005` = `Medianinkomst, tkr 2005`,
         `2006` = `Medianinkomst, tkr 2006`,
         `2007` = `Medianinkomst, tkr 2007`,
         `2008` = `Medianinkomst, tkr 2008`,
         `2009` = `Medianinkomst, tkr 2009`,
         `2010` = `Medianinkomst, tkr 2010`,
         `2011` = `Medianinkomst, tkr 2011`,
         `2012` = `Medianinkomst, tkr 2012`,
         `2013` = `Medianinkomst, tkr 2013`,
         `2014` = `Medianinkomst, tkr 2014`,
         `2015` = `Medianinkomst, tkr 2015`,
         `2016` = `Medianinkomst, tkr 2016`,
         `2017` = `Medianinkomst, tkr 2017`,
         `2018` = `Medianinkomst, tkr 2018`) %>%
  mutate(`2019` =`2018`) %>%
  pivot_longer(`2002`:`2019`, names_to = "year", values_to = "median_income"))

#Data
avg_imputed <- chairman_processed %>% 
  mutate(mandate_period = if_else(year >= 2002 & year < 2006, 1, 0),
         mandate_period = if_else(year >= 2006 & year < 2010, 2, mandate_period),
         mandate_period = if_else(year >= 2010 & year < 2014, 3, mandate_period),
         mandate_period = if_else(year >= 2014 & year < 2018, 4, mandate_period),
         mandate_period = if_else(year >= 2018, 5, mandate_period),
         minority_dummy = if_else(majority == "Minority", 1, 0),
         S_vote_share = as.numeric(S_vote_share),
         M_vote_share = as.numeric(M_vote_share),
         SD_vote_share= as.numeric(SD_vote_share)
         ) %>% 
  group_by(muni, mandate_period) %>% 
  mutate(des_avg = mean(Beslut),
         pop = mean(pop),
         median_income = mean(median_income)) %>% 
  ungroup() %>%
  select(-Beslut, -year) %>% 
  unique()

diff_imputed <- avg_imputed %>% filter(mandate_period == 2 | mandate_period == 3)

ols_imputed <- avg_imputed %>% filter(mandate_period == 5)

#Models:
bi_avg_robust_imputed <- plm(
  log(des_avg+1) ~ minority_dummy,
  data = avg_imputed,
  model = "within",
  effect = "individual",
  index = c("muni", "mandate_period"))

avg_robust_imputed <- plm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share ,
  data = avg_imputed,
  model = "within",
  effect = "individual",
  index = c("muni", "mandate_period"))

diff_robust_imputed <- plm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share ,
  data = diff_imputed,
  model = "within",
  effect = "individual",
  index = c("muni", "mandate_period"))


ols_robust_imputed <- lm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share,
  data = ols_imputed)

gmm_robust_imputed <- pgmm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share | lag(log(des_avg+1), 2:5),
  effect = "individual",
  model = "twosteps",
  transformation = "ld",
  data = avg_imputed,
  index = c("muni", "mandate_period"))
summary(gmm_robust_imputed)

se <- list(sqrt(diag(vcovHC(bi_avg_robust_imputed, type = "HC3"))),
              sqrt(diag(vcovHC(avg_robust_imputed, type = "HC3"))),
              sqrt(diag(vcovHC(diff_robust_imputed, type = "HC3"))),
              sqrt(diag(vcovHC(ols_robust_imputed))),
              sqrt(diag(vcovHC(gmm_robust_imputed)))
           )

stargazer(bi_avg_robust_imputed, avg_robust_imputed, diff_robust_imputed, ols_robust_imputed, gmm_robust_imputed,
          se = se,
          model.names = TRUE,
          multicolumn = TRUE,
          notes = "Municipality Clustered Standard Error in Parenthesis",
          type = "html",
          out = "./Regressions/Imputed_robust.html")

pwartest(bi_avg_robust_imputed)
pwartest(avg_robust_imputed)
pwartest(diff_robust_imputed)
```

```{r Strict}
cook <- cooks.distance(lm(
    log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share ,
    data = avg_data))
cook <- as.data.frame(cook) %>% 
  mutate(muni = avg_data$muni,
         mandate_period = avg_data$mandate_period) %>% 
  filter(cook > 4/865) %>%
  select(muni) %>%
  unique()

strict_filter <- chairman_des %>% 
  group_by(Kommun, year) %>%
  summarise(nDes = sum(Beslut)) %>%
  mutate(has_na = any(is.na(nDes))) %>%
  ungroup() %>%
  filter(!has_na) %>% 
  select(muni = Kommun) %>% 
  unique()

avg_strict <- primary %>% 
  mutate(mandate_period = if_else(year >= 2002 & year < 2006, 1, 0),
         mandate_period = if_else(year >= 2006 & year < 2010, 2, mandate_period),
         mandate_period = if_else(year >= 2010 & year < 2014, 3, mandate_period),
         mandate_period = if_else(year >= 2014 & year < 2018, 4, mandate_period),
         mandate_period = if_else(year >= 2018, 5, mandate_period),
         minority_dummy = if_else(majority == "Minority", 1, 0)
         ) %>% 
  group_by(muni, mandate_period) %>% 
  mutate(des_avg = mean(nDes),
         pop = mean(pop),
         median_income = mean(median_income)) %>% 
  filter(muni != "Göteborg",
         muni %in% strict_filter$muni ) %>% 
  ungroup() %>%
  select(-nDes, -year) %>% 
  unique() 
  
diff_data_strict <- avg_strict %>% filter(mandate_period == 2 | mandate_period == 3)

ols_data_strict <- avg_strict %>% filter(mandate_period == 5)

#Models:
bi_robust_strict <- plm(
  log(des_avg+1) ~ minority_dummy,
  data = avg_strict,
  model = "within",
  effect = "individual",
  index = c("muni", "mandate_period"))

avg_robust_strict <- plm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share ,
  data = avg_strict,
  model = "within",
  effect = "individual",
  index = c("muni", "mandate_period"))

diff_robust_strict <- plm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share ,
  data = diff_data_strict,
  model = "within",
  effect = "individual",
  index = c("muni", "mandate_period"))


ols_robust_strict <- lm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share,
  data = ols_data_strict)

gmm_robust_strict <- pgmm(
  log(des_avg+1) ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share | lag(log(des_avg+1), 2:5),
  effect = "individual",
  model = "twosteps",
  transformation = "ld",
  data = avg_strict,
  index = c("muni", "mandate_period"))
summary(gmm_robust_strict)


se <- list(sqrt(diag(vcovHC(bi_robust_strict, type = "HC3"))),
              sqrt(diag(vcovHC(avg_robust_strict, type = "HC3"))),
              sqrt(diag(vcovHC(diff_robust_strict, type = "HC3"))),
              sqrt(diag(vcovHC(ols_robust_strict))),
              sqrt(diag(vcovHC(gmm_robust_strict)))
           )

stargazer(bi_robust_strict, avg_robust_strict, diff_robust_strict, ols_robust_strict, gmm_robust_strict,
          se = se,
          model.names = TRUE,
          multicolumn = TRUE,
          notes = "Municipality Clustered Standard Error in Parenthesis",
          type = "html",
          out = "./Regressions/Strict_robust.html")

pwartest(bi_robust_strict)
pwartest(avg_robust_strict)
pwartest(diff_robust_strict)
```

```{r, dummy des}
dummy_avg_data <- avg_data %>% mutate(dummy_avg = if_else(des_avg == 0, 0, 1))

diff_dummy_data <- dummy_avg %>% filter(mandate_period == 2 | mandate_period == 3)

ols_dummy_data <- dummy_avg %>% filter(mandate_period == 5)

#Models:
bi_avg_dummy <- plm(
  dummy_avg ~ minority_dummy,
  data = dummy_avg_data,
  model = "within",
  effect = "individual",
  index = c("muni", "mandate_period"))

avg_dummy <- plm(
  dummy_avg ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share ,
  data = dummy_avg_data,
  model = "within",
  effect = "individual",
  index = c("muni", "mandate_period"))

diff_dummy <- plm(
  dummy_avg ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share ,
  data = diff_dummy_data,
  model = "within",
  effect = "individual",
  index = c("muni", "mandate_period"))


ols_dummy <- lm(
  dummy_avg ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share,
  data = ols_dummy_data)

gmm_dummy <- pgmm(
  dummy_avg ~ minority_dummy + log(pop) + median_income + S_length + M_length+S_vote_share+M_vote_share+SD_vote_share | lag(log(des_avg+1), 2:5),
  effect = "individual",
  model = "twosteps",
  transformation = "ld",
  data = dummy_avg_data,
  index = c("muni", "mandate_period"))
summary(gmm_dummy)


se <- list(sqrt(diag(vcovHC(bi_avg_dummy, type = "HC3"))),
              sqrt(diag(vcovHC(avg_dummy, type = "HC3"))),
              sqrt(diag(vcovHC(diff_dummy, type = "HC3"))),
              sqrt(diag(vcovHC(ols_dummy))),
              sqrt(diag(vcovHC(gmm_dummy)))
           )

stargazer(bi_avg_dummy, avg_dummy, diff_dummy, ols_dummy, gmm_dummy,
          se = se,
          model.names = TRUE,
          multicolumn = TRUE,
          notes = "Municipality Clustered Standard Error in Parenthesis",
          type = "html",
          out = "./Regressions/Robust_dummy.html")

pwartest(bi_avg_dummy)
pwartest(avg_dummy)
pwartest(diff_dummy)
```

